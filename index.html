<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a0a0a">
    <title>ROCHE - DOOMED TO LIVE</title>
    <link href="https://fonts.googleapis.com/css2?family=Overpass+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="glitch.css">
    <link rel="icon" type="image/png" href="doomed2livefavicon.png">

    <!-- Apple devices (iOS, macOS) -->
    <link rel="apple-touch-icon" href="doomed2livefavicon.png">

    <!-- Windows tiles -->
    <meta name="msapplication-TileImage" content="doomed2livefavicon.png">
    <meta name="msapplication-TileColor" content="#0a0a0a">
    <style>
        .roche-glitch {
            font-size: clamp(2.5rem, 8vw, 6rem);
            font-family: 'Akira Expanded', sans-serif;
            font-weight: 700;
        }
    </style>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');

        @font-face {
            font-family: 'Akira Expanded';
            src: url('https://cdn.jsdelivr.net/gh/ferrerokush-png/doomed2live@main/AkiraExpanded-SuperBold.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --color-bg: #0a0a0a;
            --color-text: #f5f5f5;
            --color-text-secondary: #999;
            --color-accent: #b30000;
            /* Dark Red */
            --color-accent-hover: #ff0000;
            /* Brighter Red on hover */
            --color-highlight: #00d4ff;
            /* Blue for track highlights */
            --color-border: #222;
            --space-16: 16px;
            --space-24: 24px;
            --space-32: 32px;
            --radius-base: 4px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-32);
            /* Added bottom padding for fixed footer */
            width: 100%;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 50;
            /* Ensure container is above potential hidden views */
            pointer-events: auto;
            /* Ensure events work */
        }

        .logo {
            /* removed transition for top/left */
            position: fixed;
            /* Fixed position to stay in place */
            top: var(--space-24);
            left: var(--space-24);
            font-size: 14px;
            font-weight: 900;
            /* Maximum boldness */
            letter-spacing: 2px;
            color: #b30000;
            text-transform: uppercase;
            font-family: 'Space Mono', monospace;
            z-index: 1000;
            /* Ensure it stays on top */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-shadow: 0 0 0.5px #b30000;
            /* Slight shadow to enhance boldness */
        }

        /* Ensure message is clickable */
        .message {
            position: relative;
            z-index: 100;
            /* Bring above other elements */
            text-align: center;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .message:hover {
            opacity: 0.8;
        }

        .message h1 {
            font-size: clamp(2.5rem, 8vw, 6rem);
            font-weight: 700;
            margin: 0;
            letter-spacing: -1px;
            line-height: 1.2;
            font-family: 'Akira Expanded', sans-serif;
            pointer-events: auto;
            /* Ensure h1 specifically receives clicks */
        }



        .music-view {
            display: none;
            padding: 22vh 24px 10vh 24px;
            /* Percentage based padding to push content lower */
            min-height: 100vh;
            align-items: center;
            justify-content: flex-start;
            /* Align to top with padding pushing it down */
            flex-direction: column;
            box-sizing: border-box;
        }


        .back-button {
            position: fixed;
            /* Fixed position to stay relative to fixed logo */
            top: 60px;
            /* Positioned below the logo (approx 24px + height + gap) */
            left: var(--space-24);
            background: none;
            border: none;
            color: var(--color-text);
            font-size: 14px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: color 0.2s, opacity 1s ease;
            /* Added opacity transition */
            font-family: 'Space Mono', monospace;
            z-index: 999;
            opacity: 0;
            /* Start hidden */
        }

        .music-view.organized .back-button {
            opacity: 1;
            /* Fade in when organized */
        }

        .back-button:hover {
            color: var(--color-accent);
        }

        .release-header {
            margin-bottom: var(--space-32);
            text-align: center;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .ep-artwork {
            width: 100%;
            max-width: 485px;
            /* Set to 485px */
            height: auto;
            /* Allow height to adjust */
            aspect-ratio: 1 / 1;
            /* Square aspect ratio */
            border-radius: var(--radius-base);
            margin: 0 auto var(--space-32) auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            overflow: hidden;
            /* Ensure image stays within radius */
        }

        .ep-artwork img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .release-header h2 {
            font-size: 28px;
            margin: 0 0 var(--space-16) 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Akira Expanded', sans-serif;
        }

        .release-header p {
            color: var(--color-text-secondary);
            margin: 0;
            font-size: 12px;
            font-family: 'Space Mono', monospace;
        }

        .track-list {
            display: flex;
            flex-direction: column;
            gap: 0;
            /* Remove gap, use border/padding */
            max-width: 100%;
            margin: 0 auto;
            height: auto;
            width: 100%;
            /* Ensure full width */
        }

        .track-item {
            display: flex;
            flex-direction: column;
            gap: 0;
            cursor: default;
            /* Cursor handled by buttons */
            padding: 0;
            border: 1px solid transparent;
            border-bottom: 1px solid transparent;
            /* Remove divider */
            width: 100%;
            min-height: 70px;
            /* Fixed height */
            background: transparent;
        }

        /* Ensure full width */

        .play-icon {
            font-size: 10px;
            color: var(--color-accent);
            margin-right: var(--space-16);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border: 1px solid var(--color-accent);
            border-radius: 50%;
            transition: all 0.2s;
        }

        .track-item:hover .play-icon {
            background: var(--color-accent);
            color: var(--color-bg);
        }

        .track-item:hover {
            background: transparent;
            border-color: transparent;
            border-bottom: 1px solid transparent !important;
            box-shadow: none;
        }

        .track-item.active {
            background: transparent;
            border-color: transparent;
            border-bottom: 1px solid transparent !important;
        }

        .track-item:last-child {
            border-bottom: 1px solid transparent;
            /* Use transparent instead of none to maintain 1px spacing if needed, but none is fine for look. */
            /* Actually, if we use none, height changes by 1px. Use transparent to keep layout stable. */
            border-bottom-color: transparent;
        }

        .track-item:last-child:hover {
            border-bottom-color: transparent;
            /* Keep distinct from others if needed */
        }

        .track-item-content {
            display: flex;
            width: 100%;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-16);
        }

        .track-left {
            display: flex;
            align-items: center;
            gap: var(--space-16);
            flex: 1;
        }

        .track-right {
            display: flex;
            align-items: center;
            gap: var(--space-16);
            margin-left: var(--space-32);
            flex-shrink: 0;
        }

        .play-icon-btn {
            color: var(--color-accent);
            background: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: color 0.2s;
            margin-right: 8px;
            padding: 4px;
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .play-icon-btn:hover {
            color: var(--color-accent-hover);
            background: none;
        }

        .inline-support-btn {
            background: transparent;
            color: var(--color-text);
            border: 1px solid var(--color-border);
            padding: 8px 16px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            transition: all 0.2s;
        }

        .inline-support-btn:hover {
            border-color: #b30000;
            color: #b30000;
            background: rgba(179, 0, 0, 0.1);
        }

        .track-item:hover {
            background: transparent;
        }

        .track-item.active {
            background: transparent;
            border-color: transparent;
            /* Keep layout stable */
        }

        .track-duration-inline {
            font-size: 12px;
            color: var(--color-text-secondary);
            font-family: 'Space Mono', monospace;
            margin-left: var(--space-16);
        }

        /* Player Wrapper Animation */
        /* Hide expansion elements */
        .track-player-wrapper {
            display: none !important;
        }

        /* Modified Player Styles for inline display */
        .player {
            margin-top: 0;
            background: none;
            border: none;
            border-top: 1px solid var(--color-border);
            border-radius: 0;
            padding: var(--space-16);
            max-width: none;
            display: block;
            /* Always block, controlled by wrapper */
            opacity: 1;
            /* Remove fade in since wrapper animates height */
        }

        .download-full-ep-btn {
            display: inline-block;
            margin-top: 0;
            margin-bottom: 0;
            background: #b30000;
            /* Dark red matching theme */
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            border-radius: 6px;
            transition: all 0.2s ease;
            width: auto;
            max-width: 100%;
            box-shadow: 0 2px 4px rgba(179, 0, 0, 0.3);
        }

        .download-full-ep-btn:hover {
            background: #ff0000;
            /* Brighter red on hover */
            box-shadow: 0 4px 8px rgba(179, 0, 0, 0.4);
            transform: translateY(-1px);
        }

        .download-full-ep-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(179, 0, 0, 0.3);
        }

        .track-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .track-text-container {
            display: flex;
            align-items: center;
            min-width: 0;
            margin-right: var(--space-8);
        }

        .track-title {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
            color: var(--color-text);
            font-family: 'Akira Expanded', sans-serif;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-duration-inline {
            font-size: 12px;
            color: var(--color-text-secondary);
            font-family: 'Space Mono', monospace;
            margin-left: var(--space-24);
            flex-shrink: 0;
        }

        .player {
            margin-top: var(--space-32);
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-24);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            display: none;
        }

        .player.active {
            display: block;
        }

        .player-title,
        .player-track {
            display: none;
        }

        .player-controls {
            display: flex;
            gap: var(--space-16);
            align-items: center;
            justify-content: space-between;
            /* Push items to edges */
            margin-bottom: var(--space-16);
        }

        button {
            background: none;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            border-radius: var(--radius-base);
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            font-family: 'Space Mono', monospace;
        }

        button:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        /* Specific class for download buttons - Dark red theme */
        .download-btn {
            background: transparent !important;
            color: var(--color-text) !important;
            border: 1px solid var(--color-border) !important;
            padding: 10px 20px !important;
            font-size: 12px !important;
            font-weight: 700 !important;
            text-transform: uppercase !important;
            letter-spacing: 1px !important;
            font-family: 'Space Mono', monospace !important;
            border-radius: 6px !important;
            box-shadow: none !important;
            transition: all 0.2s ease !important;
        }

        .download-btn:hover {
            background: rgba(179, 0, 0, 0.1) !important;
            border-color: #b30000 !important;
            color: #b30000 !important;
            box-shadow: 0 0 10px rgba(179, 0, 0, 0.2) !important;
            transform: translateY(-1px);
        }

        .download-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(179, 0, 0, 0.3) !important;
        }

        .player-progress {
            width: 100%;
            height: 3px;
            background: var(--color-border);
            border-radius: 2px;
            margin-bottom: var(--space-16);
            cursor: pointer;
            position: relative;
        }

        .player-progress-fill {
            height: 100%;
            background: var(--color-accent);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .player-time {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-16);
            font-family: 'Space Mono', monospace;
        }

        /* Updated Mini Player Styles - Pop up above footer */
        /* Updated Mini Player Styles - Full Width Bar */
        /* Updated Mini Player Styles - Full Width Bar Stacking on Footer */
        /* Discreet Player Styles */
        .footer-progress-container {
            position: absolute;
            top: -1px;
            /* Overlap border */
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            z-index: 1001;
        }

        .footer-progress-bar {
            height: 100%;
            background: #ff0000;
            /* Red Playhead */
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .discreet-player-info {
            position: fixed;
            bottom: 160px;
            /* Just above footer */
            left: 50%;
            /* Center horizontally */
            transform: translateX(-50%) translateY(20px);
            background: rgba(10, 10, 10, 0.85);
            /* Slightly transparent */
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 8px 16px;
            border-radius: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            pointer-events: none;
        }

        .discreet-player-info.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .discreet-status {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--color-accent);
            animation: pulse-red 2s infinite;
        }

        .discreet-text {
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            color: var(--color-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .discreet-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 8px;
            padding-left: 12px;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        .discreet-btn {
            background: none;
            border: none;
            color: var(--color-text);
            cursor: pointer;
            font-size: 10px;
            padding: 0;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .discreet-btn:hover {
            opacity: 1;
            color: var(--color-accent);
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(255, 0, 0, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
            }
        }

        .mini-player-content {
            display: flex;
            align-items: center;
            justify-content: center;
            /* Centered content again */
            gap: 60px;
            /* Large gap for spacing without compaction */
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            padding: 0 16px;
        }

        .mini-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Center text info specifically */
            text-align: center;
            overflow: hidden;
            flex: 0 1 auto;
            /* Use natural width */
            min-width: 200px;
            /* Ensure some minimum width for titles */
        }

        .mini-track-name {
            font-family: 'Akira Expanded', sans-serif;
            font-size: 11px;
            /* Slightly larger */
            color: var(--color-text);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mini-artist {
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            color: var(--color-accent);
            /* Make artist pop */
            font-weight: 700;
        }

        .mini-time {
            font-family: 'Space Mono', monospace;
            font-size: 11px;
            color: var(--color-text-secondary);
            margin-right: 16px;
        }

        .mini-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .mini-play-btn {
            background: none;
            border: 1px solid var(--color-accent);
            color: var(--color-accent);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mini-play-btn:hover {
            background: var(--color-accent);
            color: var(--color-bg);
        }

        .mini-progress-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            border-radius: 0;
        }

        .mini-progress-bar {
            height: 100%;
            background: var(--color-accent);
            width: 0%;
            border-radius: 0;
            transition: width 0.1s linear;
        }



        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 998;
            /* Below mini-player */
            border-top: 1px solid var(--color-border);
            padding: var(--space-32) var(--space-24);
            text-align: center;
            background: var(--color-bg);
            /* Ensure footer has background to cover content */
            pointer-events: auto;
            /* Ensure clickable */
        }



        .poem {
            font-size: 13px;
            color: var(--color-text);
            /* Made white for numbers */
            margin: 0 0 var(--space-16) 0;
            line-height: 1.4;
            width: 100%;
            white-space: nowrap;
            /* Force one line */
            margin-left: auto;
            margin-right: auto;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            /* Make everything bold like previous strong tags */
        }

        .poem a {
            color: var(--color-text);
            /* White by default */
            text-decoration: none;
            transition: color 0.2s;
            cursor: pointer;
        }

        .poem a:hover {
            color: #ff0000;
            /* Red on hover */
        }

        .poem br {
            content: " • ";
        }

        .socials {
            display: flex;
            gap: var(--space-24);
            justify-content: center;
            flex-wrap: wrap;
        }

        .social-link {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--color-text-secondary);
            text-decoration: none;
            transition: color 0.2s;
            font-family: 'Space Mono', monospace;
        }

        .social-link:hover {
            color: var(--color-accent);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            padding: var(--space-32);
            max-width: 500px;
            width: 90%;
            border-radius: var(--radius-base);
            position: relative;
        }

        #checkoutContent {
            max-width: 600px;
            padding: var(--space-24);
        }

        #checkout {
            margin-top: var(--space-16);
        }

        .modal-close {
            position: absolute;
            top: var(--space-16);
            right: var(--space-16);
            background: none;
            border: none;
            color: var(--color-text);
            font-size: 20px;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--color-accent);
        }

        .modal h3 {
            margin: 0 0 var(--space-24) 0;
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Akira Expanded', sans-serif;
        }

        .form-group {
            margin-bottom: var(--space-16);
        }

        .form-group label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            color: var(--color-text-secondary);
            font-family: 'Space Mono', monospace;
        }

        .form-group input {
            width: 100%;
            padding: 10px var(--space-16);
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            font-size: 14px;
            border-radius: var(--radius-base);
            transition: border-color 0.2s;
            font-family: 'Space Mono', monospace;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .amount-buttons {
            display: flex;
            gap: var(--space-16);
            margin-bottom: var(--space-16);
            flex-wrap: wrap;
        }

        .amount-btn {
            flex: 1;
            min-width: 70px;
            padding: 10px 8px;
            text-align: center;
            font-size: 12px;
        }

        .amount-btn.active {
            background: rgba(179, 0, 0, 0.1);
            /* Red tint */
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .amount-option-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            text-transform: uppercase;
            border-radius: var(--radius-base);
            transition: all 0.2s;
        }

        .amount-option-btn.active {
            border-color: var(--color-accent);
            color: var(--color-accent);
            background: rgba(179, 0, 0, 0.1);
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            background: var(--color-accent);
            color: var(--color-bg);
            font-weight: 700;
            margin-top: var(--space-16);
            border: none;
        }

        .submit-btn:hover {
            background: var(--color-accent-hover);
        }

        .modal p {
            margin: 0 0 var(--space-16) 0;
            color: var(--color-text-secondary);
            font-family: 'Space Mono', monospace;
        }

        /* Shift logo down when music view is active to avoid overlap with back button */
        /* REMOVED: Logo is now fixed at top left */
        /* body.music-active .logo { top: 64px; } */

        /* Responsive tweaks for small screens */
        /* Responsive tweaks for mobile */
        @media (max-width: 768px) {

            /* ... Logo/Back Button ... */
            .logo {
                top: 10px;
                left: 12px;
                font-size: 12px;
            }

            /* Back button hidden on home, shown only when music-active */
            .back-button {
                display: none;
            }

            body.music-active .back-button {
                display: block;
                top: 38px !important;
                left: 12px !important;
                font-size: 10px;
                opacity: 1 !important;
                padding: 4px 8px;
            }

            /* Music View - Centered Layout with Header Clearance */
            .music-view {
                padding-top: 50px;
                /* Push content down from fixed header */
                padding-bottom: 70px;
                /* Space for footer */
                padding-left: 16px;
                padding-right: 16px;
                justify-content: center;
                /* Center Vertically */
                min-height: 100dvh;
                height: 100dvh;
                overflow: hidden;
                /* Prevent body scroll */
                display: flex;
            }

            .music-content {
                gap: 2px;
                width: 100%;
                max-width: 100%;
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            .content-columns {
                display: contents;
            }

            /* 1. Artwork - 120% larger & moved down 25px more */
            .release-info {
                order: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-top: 50px;
                margin-bottom: 0;
                /* Reduced gap below artwork */
            }

            .ep-artwork {
                max-width: 185px;
                max-height: 26vh;
                margin-bottom: 0;
                /* No gap */
                margin-left: auto;
                margin-right: auto;
            }

            .release-header h2 {
                font-size: 14px;
                margin-bottom: 0;
            }

            .release-header p {
                display: none;
            }

            /* Lyrics - Positioned at bottom, between Download button and Footer */
            .lyrics-container {
                order: 4;
                /* After tracks */
                font-size: 9px;
                line-height: 1.3;
                margin: 0;
                padding: 8px;
                min-height: 2.5em;
                flex-grow: 1;
                /* Take remaining space */
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                width: 90%;
                margin-left: auto;
                margin-right: auto;
                white-space: normal;
                word-break: break-word;
            }

            /* Tracks - Pull up closer to artwork */
            .tracks-area {
                order: 2;
                width: 85%;
                max-width: 320px;
                margin: 0 auto;
                margin-top: -25px;
                /* Pull up more to reduce gap */
                flex-grow: 0;
            }

            .track-item-content {
                padding: 0;
                justify-content: flex-start;
                /* LEFT ALIGN */
                position: relative;
            }

            .track-left {
                justify-content: flex-start;
                /* LEFT ALIGN */
                width: 100%;
                gap: 12px;
            }

            .track-right {
                display: none !important;
            }

            .track-title {
                font-size: 11px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                text-align: left;
                flex: 1;
                /* Take available space */
                min-width: 0;
                /* Allow shrinking */
            }

            .track-text-container {
                flex: 1;
                display: flex;
                justify-content: space-between;
                /* Crucial for right align */
                align-items: center;
                min-width: 0;
                margin-right: 0;
                width: 100%;
                /* Ensure full width */
            }

            .track-item {
                border-bottom: none !important;
                padding: 0;
                margin: 0;
                min-height: 28px;
                display: flex;
                align-items: center;
                justify-content: flex-start;
                /* LEFT ALIGN ITEM */
            }

            .inline-support-btn {
                display: none;
            }

            .play-icon-btn {
                min-width: 16px;
                font-size: 12px;
                margin: 0;
            }

            /* Download Button Reduced by 20% (56% of original 70%) & Centered */
            .download-full-ep-btn {
                width: 56% !important;
                margin: 0 auto;
                padding: 8px;
                font-size: 9px;
                opacity: 0.9;
                display: block;
            }

            /* Button Container */
            .tracks-area>div[style*="flex"] {
                padding-left: 0 !important;
                justify-content: center !important;
                margin-top: 16px !important;
                width: 85%;
                max-width: 320px;
                margin-left: auto;
                margin-right: auto;
            }

            .tracks-area>div[style*="flex"]>button {
                width: 56% !important;
            }

            .track-list {
                width: 100%;
                padding: 0;
            }

            .track-duration-inline {
                display: block !important;
                font-size: 10px;
                color: var(--color-text-secondary);
                margin-left: 8px;
                flex-shrink: 0;
                text-align: right;
                /* Explicit right align */
            }

            .container {
                height: 100dvh;
            }

            .message h1 {
                font-size: clamp(1.8rem, 9vw, 3rem);
                width: 100%;
                padding: 0 16px;
            }

            /* Footer: Hidden on Home, Visible on Music Page */
            footer {
                display: none;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                padding: 8px 12px;
                background: var(--color-bg);
                z-index: 2147483647;
                /* MAX INT Z-Index */
                border-top: 1px solid rgba(255, 255, 255, 0.05);
                box-sizing: border-box;
            }

            body.music-active footer {
                display: block !important;
            }

            /* Footer Scrolling Animation - Entire line scrolls together */
            .poem {
                white-space: nowrap !important;
                overflow: hidden;
                box-sizing: border-box;
                padding: 0;
                width: 100%;
                display: block;
                animation: marquee 20s linear infinite;
                font-size: 11px;
            }

            @keyframes marquee {
                0% {
                    transform: translateX(100%);
                }

                100% {
                    transform: translateX(-100%);
                }
            }

            .socials {
                gap: 10px;
            }

            .social-link {
                font-size: 7px;
            }

            .discreet-player-info {
                display: none !important;
            }

            /* Global scroll lock */
            html,
            body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                position: fixed;
            }
        }
    </style>

    <style>
        /* CRT Effect & Header Transition */
        .message h1 {
            transition: opacity 1.5s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .message.clicked h1 {
            opacity: 0;
        }
    </style>

    <style>
        /* New Layout Styles */
        .music-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            /* Center vertically on mobile */
            /* flex: 1; Removed to compact layout */
            /* Take up available space */
            gap: var(--space-32);
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .music-view.visible .music-content {
            opacity: 1;
        }

        .content-columns {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: var(--space-32);
            align-items: center;
        }

        .release-info {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .tracks-area {
            width: 100%;
        }

        @media (min-width: 768px) {

            /* Desktop: Side-by-side layout, centered on page */
            .content-columns {
                flex-direction: row;
                align-items: center;
                justify-content: center;
                gap: 48px;
                width: 100%;
                padding: 0 var(--space-32);
            }

            .release-info {
                flex: 0 0 485px;
                width: 485px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .ep-artwork {
                width: 485px;
                max-width: 485px;
                margin-bottom: var(--space-16);
            }

            .tracks-area {
                flex: 0 1 650px;
                max-width: 650px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .release-header {
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                margin-bottom: 0;
            }

            .release-header h2 {
                margin-top: 0;
                margin-bottom: var(--space-16);
            }

            .release-header p {
                margin-bottom: var(--space-16);
            }

            .download-full-ep-btn {
                width: auto;
                min-width: 200px;
                margin-top: 60px;
            }
        }

        /* Logic update for Play Icon handled in JS, but ensuring CSS supports it */
        .play-icon-btn {
            /* No change needed here, JS controls content */
        }

        /* Disorganized to Organized Animation */
        .track-item {
            /* Initial disorganized state */
            opacity: 0;
            transform: translate(var(--tx), var(--ty)) rotate(var(--r));
            transition:
                opacity 0.8s cubic-bezier(0.23, 1, 0.32, 1),
                transform 1.2s cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* Organized state */
        .music-view.organized .track-item {
            opacity: 1;
            transform: translate(0, 0) rotate(0);
        }

        .release-info {
            transition: opacity 1s ease, transform 1s ease;
            opacity: 0;
            transform: translateX(-20px);
        }

        .music-view.organized .release-info {
            opacity: 1;
            transform: none;
        }

        .player {
            transition: opacity 1s ease 0.5s;
            /* Delay player fade in */
            opacity: 0;
        }

        .music-view.organized .player {
            opacity: 1;
        }

        /* Older Music Section */
        .older-music-section {
            width: auto !important;
            text-align: right;
            margin-top: 0;
            padding: 0;
            opacity: 0;
            transition: opacity 1s ease 0.5s, bottom 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            position: fixed;
            bottom: 124px;
            /* Footer is ~112px, giving ~12px gap */
            right: var(--space-24) !important;
            left: auto !important;
            z-index: 997;
            pointer-events: auto;
            background: none;
            /* Ensure no background covers anything */
        }



        .music-view.organized .older-music-section {
            opacity: 1;
        }

        .older-music-btn {
            background: none;
            border: 1px solid var(--color-border);
            color: var(--color-text-secondary);
            padding: 16px 40px;
            font-size: 14px;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Akira Expanded', sans-serif;
        }

        /* Archive Grid Styles */
        #archiveList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 32px;
            padding: 0;
            height: auto;
            max-height: 100%;
            overflow-y: visible;
            /* Allow scrolling */
            border: none;
            justify-content: center;
            /* Center the grid items */
            max-width: 900px;
            margin: 0 auto;
            /* Center the grid container */
        }

        /* Archive View Specific Layout overrides */
        #archiveView .music-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: auto;
            min-height: 60vh;
            max-width: 1000px;
        }

        #archiveView .tracks-area {
            width: 100%;
            max-width: 1000px;
            /* Expand to full width */
            flex: unset;
            height: auto;
            overflow: visible;
        }

        /* Override archive view in media query to prevent layout conflicts */
        @media (min-width: 768px) {
            #archiveView .music-content {
                flex-direction: column;
                height: auto;
                margin-top: 0;
            }

            #archiveView .tracks-area {
                max-width: 1000px;
                height: auto;
            }
        }

        #archiveList::-webkit-scrollbar {
            width: 4px;
        }

        #archiveList::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        /* Override track-item for archive grid */
        #archiveList .track-item {
            flex: unset;
            width: 100%;
            height: auto;
            border: none;
            border-radius: var(--radius-base);
            background: transparent;
            margin: 0;
            min-height: 0;
            padding: 0;
            opacity: 0;
            /* Handled by JS animation */
        }

        #archiveList .track-item:hover {
            background: transparent;
            opacity: 1;
            border: none !important;
            border-bottom: none !important;
            box-shadow: none;
            outline: none;
        }

        .archive-item {
            display: flex;
            flex-direction: column;
            gap: 12px;
            text-align: left;
            cursor: pointer;
        }

        .archive-thumb {
            width: 100%;
            aspect-ratio: 1;
            /* Square */
            overflow: hidden;
            border-radius: var(--radius-base);
            background: #222;
            position: relative;
        }

        .archive-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
            display: block;
        }

        .archive-item:hover .archive-thumb img {
            transform: scale(1.05);
        }

        .archive-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .archive-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--color-text);
            font-family: 'Akira Expanded', sans-serif;
            line-height: 1.2;
        }

        .archive-meta {
            font-size: 10px;
            color: var(--color-text-secondary);
            font-family: 'Space Mono', monospace;
            text-transform: uppercase;
        }

        .lyrics-container {
            width: 100%;
            text-align: center;
            margin-top: var(--space-32);
            font-family: 'Akira Expanded', sans-serif;
            /* Font size increased ~30% */
            font-size: clamp(16px, 2.5vw, 24px);
            color: var(--color-text);
            min-height: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            padding: 0 20px;
            /* Allow container to fill remaining vertical space to center lyrics */
            flex-grow: 1;
            /* Prevent wrapping */
            white-space: nowrap;
        }

        .lyrics-line {
            opacity: 0;
            transition: opacity 0.1s ease-out;
        }

        .lyrics-line.visible {
            opacity: 1;
        }

        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 60px;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .volume-slider:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--color-text);
            cursor: pointer;
            border: none;
            transition: background 0.2s, transform 0.2s;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            background: var(--color-accent);
            transform: scale(1.2);
        }

        .volume-slider::-moz-range-thumb {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--color-text);
            cursor: pointer;
            border: none;
            transition: background 0.2s, transform 0.2s;
        }

        .volume-slider::-moz-range-thumb:hover {
            background: var(--color-accent);
            transform: scale(1.2);
        }
    </style>
</head>

<body>
    <div class="logo">ROCHÈ</div>

    <div class="container" id="homeView">
        <div class="message" onclick="goToMusic()">
            <h1 data-text="Welcome to the void">Welcome to the void</h1>
        </div>
    </div>

    <div class="music-view" id="musicView">
        <audio id="audioPlayer"></audio>
        <button class="back-button" onclick="goHome()">← Back</button>

        <div class="music-content">
            <div class="content-columns">
                <div class="release-info">
                    <div class="release-header">
                        <div class="ep-artwork">
                            <img src="doomedtolivecoverart.png" alt="Doomed to Live EP Cover">
                        </div>
                        <!-- Removed EP text -->
                    </div>
                </div>

                <div class="tracks-area">
                    <div class="track-list" id="trackList"></div>
                    <!-- Hidden Player Template that will be moved around -->
                    <div id="playerTemplate" style="display: none;">
                        <div class="player" id="player">
                            <div class="player-title">Now Playing</div>
                            <div class="player-track" id="playerTrack">—</div>
                            <!-- Audio element moved to root -->
                            <div class="player-controls">
                                <button id="playBtn" onclick="togglePlay(event)">▶ Play</button>
                                <button class="download-btn" onclick="downloadTrack(event)">☕ Support &
                                    Download</button>
                            </div>
                            <div class="player-progress" onclick="seek(event)">
                                <div class="player-progress-fill" id="progressFill"></div>
                            </div>
                            <div class="player-time">
                                <span id="currentTime">0:00</span>
                                <span id="duration">3:00</span>
                            </div>
                        </div>
                    </div>
                    <!-- Download Full EP Button Moved Here -->
                    <div
                        style="width: 100%; display: flex; justify-content: center; margin-top: 24px; padding-left: 0;">
                        <button class="download-full-ep-btn" onclick="downloadFullEP()">Download Full EP</button>
                    </div>
                </div>
            </div>

            <!-- Lyrics Container Inside music-content -->
            <div id="lyricsContainer" class="lyrics-container">
                <div id="currentLyricLine" class="lyrics-line"></div>
            </div>
        </div>
    </div>

    <!-- Older Music Section (Outside the 2-column layout) -->
    <!-- Temporarily Deactivated
        <div class="older-music-section">
            <button class="older-music-btn" onclick="goToArchive()">PAST MOODS</button>
        </div>
        -->
    </div>

    <!-- Archive View (Reusing layout structure) -->
    <!-- Temporarily Deactivated
    <div class="music-view" id="archiveView">
        <button class="back-button" onclick="returnToLatest()">← Latest</button>

        <div class="music-content">
            <div class="tracks-area">
                <div class="track-list" id="archiveList">
                    Populated by JS
                </div>
            </div>
        </div>
    </div>
    -->

    <!-- Mini Player (appears above footer when playing) -->
    <!-- Mini Player (appears above footer when playing) -->
    <!-- Discreet Player Info (Bottom Right) -->
    <div class="discreet-player-info" id="discreetPlayer">
        <div class="discreet-status"></div>
        <div class="discreet-text">
            <span id="discreetTrackName" style="margin-right: 8px;">Doomed to Live</span>
            <span id="discreetTime" style="color: var(--color-text-secondary); font-size: 9px;">0:00 / 0:00</span>
        </div>
        <div class="discreet-controls">
            <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.05" value="1"
                oninput="setVolume(this.value)">
            <button class="discreet-btn" id="discreetPlayBtn" onclick="togglePlay()">▶</button>
        </div>
    </div>

    <footer>
        <!-- Progress Bar Integrated into Footer Top Border -->
        <div class="footer-progress-container" id="footerProgressContainer" onclick="seekFooter(event)">
            <div class="footer-progress-bar" id="footerProgressBar"></div>
        </div>
        <div class="poem">
            <a href="https://www.samaritans.org/" target="_blank" rel="noopener noreferrer">SAMARITANS</a> <span
                style="color: var(--color-accent)">116 123</span> • <a href="https://www.thecalmzone.net/"
                target="_blank" rel="noopener noreferrer">CALM</a> <span style="color: var(--color-accent)">0800 58 58
                58</span> • <a href="https://www.papyrus-uk.org/" target="_blank" rel="noopener noreferrer">PAPYRUS</a>
            <span style="color: var(--color-accent)">0800 068 4141</span> • <a
                href="https://www.crisis.org.uk/get-help/" target="_blank" rel="noopener noreferrer">CRISIS</a> <span
                style="color: var(--color-accent)">85258</span>
        </div>
        <div class="socials">
            <a href="https://tiktok.com/@rocheofficiel" class="social-link">TikTok</a>
            <a href="https://instagram.com/rocheofficiel" class="social-link">Instagram</a>
            <a href="https://youtube.com/@rocheofficiel" class="social-link">YouTube</a>
            <a href="https://open.spotify.com/artist/2EJmFMBLaeIYrmKK15iQ3M" class="social-link">Spotify</a>
        </div>
    </footer>

    <!-- Sympathy Modal (First Interaction) -->
    <div class="modal" id="sympathyModal">
        <div class="modal-content" style="text-align: center;">
            <button class="modal-close" onclick="closeModal('sympathyModal')">×</button>
            <h3 style="margin-bottom: 32px; font-size: 20px;">1 Second Mate!</h3>
            <p style="font-size: 14px; line-height: 1.6; margin-bottom: 24px;">
                Toss a penny in the hat for the poor noisemaker. A warm meal buys a
                sweeter beat, it does.
            </p>
            <p style="font-size: 14px; line-height: 1.6; margin-bottom: 32px; color: var(--color-icon);">
                Or take the tune for naught, if fortune hasn't favored ye this week.
            </p>
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <button class="submit-btn" onclick="openPaymentModal()">Toss a Penny</button>
                <button class="submit-btn"
                    style="background: transparent; border: 1px solid var(--color-text-secondary); color: var(--color-text-secondary);"
                    onclick="openContactModal()">JUST FUCKING DOWNLOAD!</button>
            </div>
        </div>
    </div>

    <!-- Payment Input Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('paymentModal')">×</button>
            <button class="back-link" onclick="backToSympathy()"
                style="border: none; background: none; color: var(--color-text-secondary); cursor: pointer; margin-bottom: 16px; padding: 0;">←
                Back</button>
            <h3>Toss a Penny</h3>
            <p id="paymentDescription">Select your contribution amount.</p>

            <div class="form-group">
                <label>Amount (£)</label>
                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                    <button class="amount-option-btn active" onclick="setPaymentAmount('min')">Minimum</button>
                    <button class="amount-option-btn" onclick="setPaymentAmount('custom')">Custom</button>
                </div>
                <input type="number" id="paymentAmountInput" placeholder="Enter amount" step="0.01">
                <p id="minAmountMsg" style="font-size: 10px; color: var(--color-accent); margin-top: 4px;">Minimum:
                    £1.00
                </p>
            </div>

            <button class="submit-btn" onclick="initiateStripeCheckout()">Proceed to Checkout</button>
        </div>
    </div>

    <!-- Contact Form Modal (Free MP3) -->
    <div class="modal" id="contactModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('contactModal')">×</button>
            <button class="back-link" onclick="backToSympathy()"
                style="border: none; background: none; color: var(--color-text-secondary); cursor: pointer; margin-bottom: 16px; padding: 0;">←
                Back</button>
            <h3>Fortune Hasn't Favored?</h3>
            <p>No worries. Just let me know who's listening.</p>

            <form id="freeDownloadForm" onsubmit="submitFreeForm(event)">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="freeName" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="freeEmail" required>
                </div>
                <div class="form-group">
                    <label>Phone (Optional)</label>
                    <input type="tel" id="freePhone">
                </div>
                <button type="submit" class="submit-btn" style="background: var(--color-text-secondary);">Get
                    MP3s</button>
            </form>
        </div>
    </div>

    <!-- Stripe Checkout Modal -->
    <div class="modal" id="checkoutModal">
        <div class="modal-content" style="max-width: 800px; width: 95%;">
            <button class="modal-close" onclick="closeModal('checkoutModal')">×</button>
            <div id="stripe-checkout-container"></div>
        </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const musicData = {
            doomed: {
                title: 'Doomed to Live',
                type: 'EP',
                year: '2025',
                cover: 'doomedtolivecoverart.png',
                tracks: [
                    {
                        title: 'Doomed to Live',
                        duration: '3:45',
                        mp3Url: 'downloads/singles/mp3/doomedtolive.mp3',
                        wavUrl: 'https://music.doomed2live.com/DOOMED%20TO%20LIVE.wav'
                    },
                    {
                        title: 'If Only',
                        duration: '4:12',
                        mp3Url: 'downloads/singles/mp3/if only.mp3',
                        wavUrl: 'https://music.doomed2live.com/IF%20ONLY.wav'
                    },
                    {
                        title: 'Why Do Fools Fall In Love',
                        duration: '3:58',
                        mp3Url: 'downloads/singles/mp3/why do fools fall in love.mp3',
                        wavUrl: 'https://music.doomed2live.com/WHY%20DO%20FOOLS%20FALL%20IN%20LOVE.wav'
                    },
                    {
                        title: 'Mayday',
                        duration: '3:32',
                        mp3Url: 'downloads/singles/mp3/Mayday.mp3',
                        wavUrl: 'https://music.doomed2live.com/MAYDAY.wav'
                    },
                    {
                        title: 'End Like This',
                        duration: '4:28',
                        mp3Url: 'downloads/singles/mp3/end likethis.mp3',
                        wavUrl: 'https://music.doomed2live.com/END%20LIKE%20THIS.wav'
                    }
                ],
                fullEpZip: 'https://music.doomed2live.com/DOOMED%20TO%20LIVE%20FULL%20EP.zip'
            },
            // ... (rest of old data kept as is, assumed plain placeholders for now)
            armor: {
                title: 'Armor',
                type: 'Single',
                year: '2025',
                cover: 'old cover art/armor.jpg',
                tracks: [{ title: 'Armor', duration: '2:45', downloadUrl: '#' }]
            },
            overu: {
                title: 'Over U',
                type: 'Single',
                year: '2025',
                cover: 'old cover art/over u.jpg',
                tracks: [{ title: 'Over U', duration: '2:50', downloadUrl: '#' }]
            },
            rain: {
                title: 'Rain',
                type: 'Single',
                year: '2025',
                cover: 'old cover art/rain.jpg',
                tracks: [{ title: 'Rain', duration: '3:20', downloadUrl: '#' }]
            },
            legaltender: {
                title: 'Legal Tender',
                type: 'Single',
                year: '2025',
                cover: 'old cover art/legal tender.jpg',
                tracks: [{ title: 'Legal Tender', duration: '2:55', downloadUrl: '#' }]
            },
            americandream: {
                title: 'American Dream',
                type: 'Single',
                year: '2025',
                cover: 'old cover art/americandreams.jpg',
                tracks: [{ title: 'American Dream', duration: '3:15', downloadUrl: '#' }]
            },
            interim: {
                title: 'Interim',
                type: 'Single',
                year: '2025',
                cover: 'old cover art/interim.jpg',
                tracks: [{ title: 'Interim', duration: '3:05', downloadUrl: '#' }]
            },
            setmefree: {
                title: 'Set Me Free',
                type: 'Single',
                year: '2025',
                cover: 'old cover art/set me free.jpg',
                tracks: [{ title: 'Set Me Free', duration: '3:10', downloadUrl: '#' }]
            },
            deepend: {
                title: 'Deep End',
                type: 'Single',
                year: '2024',
                cover: 'old cover art/Deep End.jpg',
                tracks: [{ title: 'Deep End', duration: '3:00', downloadUrl: '#' }]
            },
            dejavu: {
                title: 'Deja Vu',
                type: 'Single',
                year: '2024',
                cover: 'old cover art/deja vu.jpg',
                tracks: [{ title: 'Deja Vu', duration: '3:00', downloadUrl: '#' }]
            },
            mademan: {
                title: 'Made Man',
                type: 'Single',
                year: '2024',
                cover: 'old cover art/made man.jpg',
                tracks: [{ title: 'Made Man', duration: '3:00', downloadUrl: '#' }]
            },
            playstation: {
                title: 'Playstation',
                type: 'Single',
                year: '2024',
                cover: 'old cover art/playstation.jpg',
                tracks: [{ title: 'Playstation', duration: '3:00', downloadUrl: '#' }]
            },
            go: {
                title: 'GO',
                type: 'Single',
                year: '2023',
                cover: 'old cover art/go.jpg',
                tracks: [
                    { title: 'GO', duration: '2:30', downloadUrl: '#' }
                ]
            }
        };

        // Global state
        let currentTrack = null;
        let selectedAmount = 0;
        let isPlaying = false;
        let isFullEPDownload = false;
        let previousView = 'home'; // Track where we came from
        let placeholderAudio = null; // Cache for placeholder audio
        const trackPlaceholders = {}; // Cache placeholders per track

        // Lyrics State
        let lyricsData = [];
        let currentLyricIndex = -1;
        let lyricTimeout = null;

        function goToMusic() {
            const message = document.querySelector('.message');
            message.classList.add('clicked');

            previousView = 'home';

            setTimeout(() => {
                document.body.classList.add('music-active');
                document.getElementById('homeView').style.display = 'none';
                document.getElementById('homeView').style.display = 'none';
                const archiveView = document.getElementById('archiveView');
                if (archiveView) archiveView.style.display = 'none'; // Ensure archive is hidden

                const musicView = document.getElementById('musicView');
                musicView.style.display = 'flex';

                // Trigger reflow
                void musicView.offsetWidth;

                musicView.classList.add('visible');
                loadEP('doomed'); // Default load

                setTimeout(() => {
                    musicView.classList.add('organized');
                }, 100);
            }, 1500);
        }

        function goToArchive() {
            const musicView = document.getElementById('musicView');
            const archiveView = document.getElementById('archiveView');
            if (!archiveView) return; // Safety check

            // Hide Music View
            musicView.classList.remove('visible', 'organized');

            setTimeout(() => {
                musicView.style.display = 'none';

                // Show Archive View
                archiveView.style.display = 'flex';
                void archiveView.offsetWidth;
                archiveView.classList.add('visible');

                loadArchive();

                setTimeout(() => {
                    archiveView.classList.add('organized');
                }, 100);
            }, 500);
        }

        function returnToLatest() {
            // Go back to the main Music View (Doomed to Live)
            const musicView = document.getElementById('musicView');
            const archiveView = document.getElementById('archiveView');

            if (archiveView) archiveView.classList.remove('visible', 'organized');

            setTimeout(() => {
                if (archiveView) archiveView.style.display = 'none';

                musicView.style.display = 'flex';
                void musicView.offsetWidth;
                musicView.classList.add('visible');
                loadEP('doomed'); // Reset to latest

                setTimeout(() => {
                    musicView.classList.add('organized');
                }, 100);
            }, 500);
        }

        function goHome() {
            document.body.classList.remove('music-active');
            const musicView = document.getElementById('musicView');
            const archiveView = document.getElementById('archiveView');

            // Stop audio and hide mini-player
            audioPlayer.pause();
            isPlaying = false;
            currentTrack = null;
            updateMiniPlayer();

            // Handle closing whichever view is open
            if (musicView.style.display !== 'none') {
                musicView.classList.remove('visible', 'organized');
                setTimeout(() => { musicView.style.display = 'none'; finishHomeTransition(); }, 500);
            } else if (archiveView) {
                archiveView.classList.remove('visible', 'organized');
                setTimeout(() => { archiveView.style.display = 'none'; finishHomeTransition(); }, 500);
            } else {
                finishHomeTransition();
            }
        }

        function finishHomeTransition() {
            document.getElementById('homeView').style.display = 'flex';
            audioPlayer.pause();
            isPlaying = false;
            if (document.getElementById('playBtn')) document.getElementById('playBtn').textContent = '▶ Play';

            const message = document.querySelector('.message');
            message.classList.remove('clicked');
        }

        function loadEP(epKey) {
            const data = musicData[epKey];
            const musicView = document.getElementById('musicView');

            // Reset player state - move player back to template if it's in an old track
            const player = document.getElementById('player');
            const playerTemplate = document.getElementById('playerTemplate');

            // Remove active states from old tracks before clearing
            document.querySelectorAll('.track-item').forEach(item => {
                item.classList.remove('active');
                const wrapper = item.querySelector('.track-player-wrapper');
                if (wrapper) {
                    wrapper.classList.remove('expanded');
                }
            });

            // Ensure player is in template before clearing track list
            if (player && player.parentElement) {
                const currentParent = player.parentElement;
                // If player is not already in template, move it there
                if (currentParent.id !== 'playerTemplate') {
                    if (currentParent.removeChild) {
                        currentParent.removeChild(player);
                    }
                    if (playerTemplate) {
                        playerTemplate.appendChild(player);
                    }
                    player.style.display = 'none';
                }
            }

            // Reset current track state
            currentTrack = null;
            isPlaying = false;
            const audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.src = '';
                audioPlayer.load();
            }
            updateMiniPlayer();

            // Update Header Info
            // Title removed - only showing type now
            const releaseTypeEl = musicView.querySelector('#releaseType');
            if (releaseTypeEl) {
                releaseTypeEl.textContent = data.type;
            }

            // Update Cover Art
            const artworkImg = musicView.querySelector('.ep-artwork img');
            if (data.cover) {
                artworkImg.src = data.cover;
            } else {
                artworkImg.src = 'doomedtolivecoverart.png'; // Fallback
            }

            const trackList = document.getElementById('trackList');
            trackList.innerHTML = '';

            // Handle Download Button Visibility
            const downloadBtn = musicView.querySelector('.download-full-ep-btn');
            if (epKey === 'doomed') {
                downloadBtn.style.display = 'inline-block';
                // Also ensure Back button goes to Home
                musicView.querySelector('.back-button').onclick = goHome;
                musicView.querySelector('.back-button').textContent = "← Back";
                // Show Archive Button
                const olderMusicSection = musicView.querySelector('.older-music-section');
                if (olderMusicSection) olderMusicSection.style.display = 'block';
            } else {
                // If viewing an older release inside the main player view
                downloadBtn.style.display = 'none'; // Only Doomed has full EP download logic for now

                // Change Back button to return to Archive
                musicView.querySelector('.back-button').onclick = goToArchive;
                musicView.querySelector('.back-button').textContent = "← Archives";

                // Hide Archive Button (we are already in a sub-view)
                const olderMusicSection = musicView.querySelector('.older-music-section');
                if (olderMusicSection) olderMusicSection.style.display = 'none';
            }

            data.tracks.forEach((track, index) => {
                const trackEl = document.createElement('div');
                trackEl.className = 'track-item';

                // Random values for disorganization effect
                const tx = (Math.random() * 60 - 30) + 'px';
                const ty = (Math.random() * 60 + 20) + 'px';
                const r = (Math.random() * 10 - 5) + 'deg';

                trackEl.style.setProperty('--tx', tx);
                trackEl.style.setProperty('--ty', ty);
                trackEl.style.setProperty('--r', r);
                // Stagger transition delays
                trackEl.style.transitionDelay = (index * 0.05) + 's';

                // Static HTML structure for inline player
                trackEl.innerHTML = `
                    <div class="track-item-content">
                        <div class="track-left">
                            <div class="play-icon-btn">▶</div>
                            <div class="track-text-container">
                                <span class="track-title">${track.title}</span>
                                <span class="track-duration-inline">${track.duration}</span>
                            </div>
                        </div>
                        <div class="track-right">
                            <button class="inline-support-btn" onclick="downloadTrack(event, '${epKey}', ${index})">Download</button>
                        </div>
                    </div>
                `;

                // Pass event to prevent bubbles handled by buttons
                trackEl.onclick = (e) => {
                    // If clicked explicitly on support button, it's handled there
                    if (e.target.closest('.inline-support-btn')) return;
                    selectTrack(track, trackEl);
                };

                trackList.appendChild(trackEl);
            });
        }

        function loadArchive() {
            const list = document.getElementById('archiveList');
            list.innerHTML = '';

            // Filter keys (excluding 'doomed') and assume they are in chronological order (or user provided order)
            // If explicit sorting is needed based on year, we can do:
            // const keys = Object.keys(musicData)
            //    .filter(k => k !== 'doomed')
            //    .sort((a, b) => parseInt(musicData[b].year || 0) - parseInt(musicData[a].year || 0));
            // But preserving object definition order usually works if defined correctly.
            const keys = Object.keys(musicData).filter(k => k !== 'doomed');

            keys.forEach((key, index) => {
                const item = musicData[key];
                const el = document.createElement('div');
                el.className = 'track-item'; // Reuse animation class for fade in

                // Simplified animation for grid
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                el.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                el.style.transitionDelay = (index * 0.05) + 's';

                // Add organized class logic
                setTimeout(() => {
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                }, 50);

                el.innerHTML = `
                    <div class="archive-item" onclick="viewRelease('${key}')">
                        <div class="archive-thumb">
                            <img src="${item.cover || 'doomedtolivecoverart.png'}" 
                                 alt="${item.title}" 
                                 onerror="this.src='doomedtolivecoverart.png'">
                        </div>
                        <div class="archive-info">
                            <div class="archive-title">${item.title}</div>
                            <div class="archive-meta">${item.type} • ${item.year || '2025'}</div>
                        </div>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function viewRelease(key) {
            // Switch from Archive View to Music View (populated with release)
            const archiveView = document.getElementById('archiveView');
            const musicView = document.getElementById('musicView');

            archiveView.classList.remove('visible', 'organized');

            setTimeout(() => {
                archiveView.style.display = 'none';

                musicView.style.display = 'flex';
                void musicView.offsetWidth;
                musicView.classList.add('visible');

                loadEP(key);

                setTimeout(() => {
                    musicView.classList.add('organized');
                }, 100);
            }, 500);
        }

        function selectTrack(track, trackEl) {
            const audioPlayer = document.getElementById('audioPlayer');

            if (!audioPlayer) return;

            // Check if clicking the same track
            if (currentTrack === track) {
                // Toggle Play/Pause
                if (isPlaying) {
                    audioPlayer.pause();
                    isPlaying = false;
                } else {
                    audioPlayer.play();
                    isPlaying = true;
                }
                updateTrackIcons();
                updateMiniPlayer();
                return;
            }

            // New Track Selection
            // Reset previous active class
            document.querySelectorAll('.track-item').forEach(item => item.classList.remove('active'));
            trackEl.classList.add('active');

            currentTrack = track;
            loadLyrics(track.title);

            // Audio Logic
            audioPlayer.pause();
            isPlaying = false;

            if (track.mp3Url) {
                audioPlayer.src = track.mp3Url;
            } else if (track.downloadUrl && track.downloadUrl !== '#') {
                // Fallback for older data structure if any
                audioPlayer.src = track.downloadUrl;
            } else {
                // Placeholder generation logic (Fallback)
                const durationParts = track.duration.split(':');
                const minutes = parseInt(durationParts[0]) || 0;
                const seconds = parseInt(durationParts[1]) || 0;
                const totalSeconds = minutes * 60 + seconds;
                const duration = totalSeconds || 180;

                if (!trackPlaceholders[track.title]) {
                    trackPlaceholders[track.title] = generatePlaceholderAudio(duration);
                }
                audioPlayer.src = trackPlaceholders[track.title];
            }

            audioPlayer.load();

            // Auto play
            audioPlayer.play().then(() => {
                isPlaying = true;
                updateTrackIcons();
                updateMiniPlayer();
            }).catch(e => console.log('Autoplay prevented', e));
        }

        function updateTrackIcons() {
            const isMobile = window.innerWidth <= 768;

            document.querySelectorAll('.track-item').forEach(item => {
                const btn = item.querySelector('.play-icon-btn');

                // If this is the active track
                if (item.classList.contains('active')) {
                    if (isPlaying) {
                        // Use universally supported pause bars (II) instead of emoji
                        btn.textContent = '❚❚';
                    } else {
                        btn.textContent = '▶';
                    }
                } else {
                    // Inactive tracks always play icon
                    btn.textContent = '▶';
                }
            });

            // Update mini player button if exists
            const miniBtn = document.getElementById('miniPlayBtn');
            if (miniBtn) miniBtn.textContent = isPlaying ? '❚❚' : '▶';
        }

        // Ensure icon updates on resize if needed
        window.addEventListener('resize', updateTrackIcons);

        function generatePlaceholderAudio(durationSeconds = 180) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const duration = durationSeconds || 180; // Default to 3 minutes
            const sampleRate = audioContext.sampleRate;
            const buffer = audioContext.createBuffer(1, duration * sampleRate, sampleRate);
            const data = buffer.getChannelData(0);

            // Create a more interesting tone with slight variation
            const baseFreq = 261.63; // C4
            for (let i = 0; i < buffer.length; i++) {
                const t = i / sampleRate;
                const freq = baseFreq + Math.sin(t * 0.5) * 10; // Slight vibrato
                data[i] = Math.sin(t * freq * 2 * Math.PI) * 0.2 * (1 - t / duration); // Fade out
            }

            const wav = audioBufferToWav(buffer);
            const blob = new Blob([wav], { type: 'audio/wav' });
            return URL.createObjectURL(blob);
        }

        function audioBufferToWav(audioBuffer) {
            const numberOfChannels = audioBuffer.numberOfChannels;
            const sampleRate = audioBuffer.sampleRate;
            const format = 1;
            const bitDepth = 16;
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numberOfChannels * bytesPerSample;
            const channels = [];
            for (let i = 0; i < numberOfChannels; i++) {
                channels.push(audioBuffer.getChannelData(i));
            }
            const length = audioBuffer.length * numberOfChannels * bytesPerSample;
            const arrayBuffer = new ArrayBuffer(44 + length);
            const view = new DataView(arrayBuffer);

            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            const floatTo16BitPCM = (output, offset, input) => {
                for (let i = 0; i < input.length; i++, offset += 2) {
                    const s = Math.max(-1, Math.min(1, input[i]));
                    output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
                }
            };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numberOfChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(36, 'data');
            view.setUint32(40, length, true);

            let offset = 44;
            for (let i = 0; i < numberOfChannels; i++) {
                floatTo16BitPCM(view, offset, channels[i]);
                offset += channels[i].length * bytesPerSample;
            }

            return arrayBuffer;
        }

        function togglePlay(event) {
            if (event) event.stopPropagation();
            if (!currentTrack) return;
            const audioPlayer = document.getElementById('audioPlayer');

            if (isPlaying) {
                audioPlayer.pause();
                isPlaying = false;
            } else {
                audioPlayer.play();
                isPlaying = true;
            }
            updateTrackIcons();
            updateMiniPlayer();
        }

        function togglePlayFromMini() {
            togglePlay(null);
        }

        function seekFooter(event) {
            if (!audioPlayer.src || !audioPlayer.duration) return;
            const container = event.currentTarget;
            const rect = container.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = percent * audioPlayer.duration;
        }

        function updateMiniPlayer() {
            const discreetPlayer = document.getElementById('discreetPlayer');
            const trackName = document.getElementById('discreetTrackName');
            const playBtn = document.getElementById('discreetPlayBtn');

            if (!currentTrack) {
                discreetPlayer.classList.remove('visible');
                document.body.classList.remove('has-mini-player');
                return;
            }

            // Show discreet player
            discreetPlayer.classList.add('visible');
            document.body.classList.add('has-mini-player');

            if (trackName) trackName.textContent = currentTrack.title;
            if (playBtn) playBtn.textContent = isPlaying ? '⏸' : '▶';
        }

        function downloadTrack(event) {
            if (event) event.stopPropagation();
            if (!currentTrack) return;
            isFullEPDownload = false;
            document.getElementById('donationModal').classList.add('active');
        }

        function downloadFullEP() {
            isFullEPDownload = true;
            // Set a dummy "current track" for the modal title or logic if needed, 
            // or modify modal logic to handle full EP text
            document.querySelector('#donationModal h3').textContent = "Support Full EP";
            document.getElementById('donationModal').classList.add('active');
        }

        function seek(event) {
            if (!audioPlayer.src || !audioPlayer.duration) return;
            const rect = event.currentTarget.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = percent * audioPlayer.duration;
        }

        audioPlayer.addEventListener('timeupdate', () => {
            const current = Math.floor(audioPlayer.currentTime);
            const minutes = Math.floor(current / 60);
            const seconds = current % 60;
            const currentTimeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            document.getElementById('currentTime').textContent = currentTimeStr;

            // Update mini-player time (Legacy)
            if (document.getElementById('miniTime')) {
                const totalMinutes = Math.floor(audioPlayer.duration / 60) || 0;
                const totalSeconds = Math.floor(audioPlayer.duration % 60) || 0;
                const durationStr = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
                document.getElementById('miniTime').textContent = `${currentTimeStr} / ${durationStr}`;
            }

            // Update Discreet Time
            if (document.getElementById('discreetTime')) {
                const totalMinutes = Math.floor(audioPlayer.duration / 60) || 0;
                const totalSeconds = Math.floor(audioPlayer.duration % 60) || 0;
                const durationStr = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
                document.getElementById('discreetTime').textContent = `${currentTimeStr} / ${durationStr}`;
            }

            const percent = audioPlayer.duration ? (audioPlayer.currentTime / audioPlayer.duration) * 100 : 0;
            document.getElementById('progressFill').style.width = percent + '%';

            // Sync Footer Progress
            const footerProgressBar = document.getElementById('footerProgressBar');
            if (footerProgressBar) footerProgressBar.style.width = percent + '%';

            syncLyrics();
        });

        audioPlayer.addEventListener('ended', () => {
            if (document.getElementById('playBtn')) document.getElementById('playBtn').textContent = '▶ Play';
            if (document.getElementById('discreetPlayBtn')) document.getElementById('discreetPlayBtn').textContent = '▶';
            isPlaying = false;
            updateTrackIcons();
            updateMiniPlayer();
        });

        // Setup Mini Player Scrubbing
        function setupMiniScrubbing() {
            const container = document.getElementById('miniProgressContainer');
            if (!container) return;

            container.addEventListener('click', (e) => {
                if (!audioPlayer.duration) return;
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const percentage = x / rect.width;
                audioPlayer.currentTime = percentage * audioPlayer.duration;
            });
        }

        // Call this on init
        setupMiniScrubbing();

        function togglePlay() {
            if (!currentTrack) return;
            const audioPlayer = document.getElementById('audioPlayer');

            if (isPlaying) {
                audioPlayer.pause();
                isPlaying = false;
            } else {
                audioPlayer.play();
                isPlaying = true;
            }
            updateTrackIcons();
            updateMiniPlayer();
        }

        // Initialize Stripe
        let stripe;

        async function initStripe() {
            try {
                const response = await fetch('/api/config');
                const { publishableKey } = await response.json();
                if (publishableKey) {
                    stripe = Stripe(publishableKey);
                }
            } catch (e) {
                console.error("Could not fetch Stripe key", e);
            }
        }
        initStripe();

        // Multi-Step Modal Logic
        let selectedPaymentType = 'min'; // 'min' or 'custom'
        let stripeCheckout = null;

        function downloadTrack(event, epKey, index) {
            if (event) event.stopPropagation();

            // If specific track args provided, update context
            if (epKey && typeof index === 'number') {
                const track = musicData[epKey].tracks[index];


                if (track) {
                    currentTrack = track;
                    // Note: We update currentTrack for metadata context, 
                    // but we don't necessarily start playing it unless they click play.
                }
            }

            if (!currentTrack) return;
            isFullEPDownload = false;
            document.getElementById('sympathyModal').classList.add('active');
        }

        function downloadFullEP() {
            isFullEPDownload = true;
            document.getElementById('sympathyModal').classList.add('active');
        }

        function openPaymentModal() {
            closeModal('sympathyModal');
            document.getElementById('paymentModal').classList.add('active');

            // Set correct minimum message
            const minMsg = document.getElementById('minAmountMsg');
            const desc = document.getElementById('paymentDescription');
            if (isFullEPDownload) {
                minMsg.textContent = "Minimum: £3.99";
                desc.textContent = "Support the Full EP (Min £3.99)";
            } else {
                minMsg.textContent = "Minimum: £1.00";
                desc.textContent = "Support this Track (Min £1.00)";
            }

            setPaymentAmount('min'); // Default to minimum
        }

        function openContactModal() {
            closeModal('sympathyModal');
            document.getElementById('contactModal').classList.add('active');
        }

        function backToSympathy() {
            closeModal('paymentModal');
            closeModal('contactModal');
            closeModal('checkoutModal');
            document.getElementById('sympathyModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');

            // Reset states if needed
            if (modalId === 'paymentModal') {
                document.getElementById('paymentAmountInput').value = '';
            }
            if (modalId === 'checkoutModal' && stripeCheckout) {
                stripeCheckout.unmount();
                stripeCheckout = null;
                document.getElementById('stripe-checkout-container').innerHTML = '';
            }
        }

        function setPaymentAmount(type) {
            selectedPaymentType = type;
            const input = document.getElementById('paymentAmountInput');
            const buttons = document.querySelectorAll('.amount-option-btn');

            buttons.forEach(btn => btn.classList.remove('active'));

            if (type === 'min') {
                buttons[0].classList.add('active');
                input.value = isFullEPDownload ? 3.99 : 1.00;
                input.readOnly = true;
            } else {
                buttons[1].classList.add('active');
                input.value = '';
                input.readOnly = false;
                input.focus();
            }
        }

        async function initiateStripeCheckout() {
            const amountInput = document.getElementById('paymentAmountInput');
            let amount = parseFloat(amountInput.value);
            const minAmount = isFullEPDownload ? 3.99 : 1.00;
            const itemTitle = isFullEPDownload ? "Doomed to Live (Full EP)" : currentTrack.title;
            const downloadUrl = isFullEPDownload ? musicData.doomed.fullEpZip : currentTrack.wavUrl;

            if (isNaN(amount) || amount < minAmount) {
                alert(`Please enter a valid amount (Minimum £${minAmount})`);
                return;
            }

            // Capture Email/Name for record (Optional: send to your DB here)
            // But main focus is checkout

            // Open Checkout Modal
            closeModal('paymentModal');
            document.getElementById('checkoutModal').classList.add('active');

            try {
                // Call backend to create checkout session
                const response = await fetch('/api/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: amount, // Send amount in GBP (backend converts to pence)
                        itemTitle: itemTitle,
                        // We could capture email/name from a form before this step if desired
                        // but current UI asks for amount -> checkout. Checkout collects email.
                    })
                });

                const { clientSecret, error } = await response.json();

                if (error) {
                    console.error('API Error:', error);
                    alert('Error starting checkout: ' + error);
                    closeModal('checkoutModal');
                    return;
                }

                // Initialize embedded checkout
                stripeCheckout = await stripe.initEmbeddedCheckout({
                    clientSecret: clientSecret
                });

                // Mount the checkout form
                stripeCheckout.mount(document.getElementById('stripe-checkout-container'));

            } catch (err) {
                console.error('Checkout error:', err);
                alert('Could not initiate checkout. Check console.');
                closeModal('checkoutModal');
            }
        }

        async function submitFreeForm(event) {
            event.preventDefault();
            const name = document.getElementById('freeName').value;
            const email = document.getElementById('freeEmail').value;
            const phone = document.getElementById('freePhone').value;

            // Google Form Submission info
            const FORM_ID = "1HJFNpv5LnyQFUd9yNgDGIhoMBBc9VdDj18NU3T8Qcpg";
            const ENTRY_NAME = "entry.1740210107";
            const ENTRY_EMAIL = "entry.1802953598";
            const ENTRY_PHONE = "entry.5498969";

            const submitUrl = `https://docs.google.com/forms/d/${FORM_ID}/formResponse`;

            // Create a hidden iframe to target the form submission (prevents redirect)
            let iframe = document.getElementById('hidden_iframe');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.name = 'hidden_iframe';
                iframe.id = 'hidden_iframe';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }

            // Create a temporary form to submit
            const form = document.createElement('form');
            form.target = 'hidden_iframe';
            form.action = submitUrl;
            form.method = 'POST';

            // Add inputs
            const addInput = (name, value) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = value;
                form.appendChild(input);
            };

            addInput(ENTRY_NAME, name);
            addInput(ENTRY_EMAIL, email);
            if (phone) addInput(ENTRY_PHONE, phone);

            document.body.appendChild(form);
            form.submit();

            // Cleanup
            setTimeout(() => {
                document.body.removeChild(form);
            }, 1000);

            // Close modal and show success logic
            closeModal('contactModal');

            const itemTitle = isFullEPDownload ? "Doomed to Live (Full EP)" : currentTrack.title;
            const downloadUrl = isFullEPDownload ? musicData.doomed.fullEpZip : currentTrack.mp3Url;

            alert(`Thanks ${name}! Your details have been sent to the list.\n\nDownloading ${itemTitle}...`);

            // Trigger download
            downloadFile(downloadUrl, itemTitle);
        }

        // --- Helper Functions for Lyrics and Volume ---

        function setVolume(value) {
            const audio = document.getElementById('audioPlayer');
            if (audio) audio.volume = Math.max(0, Math.min(1, value));
        }

        async function loadLyrics(title) {
            lyricsData = [];
            currentLyricIndex = -1;
            const container = document.getElementById('currentLyricLine');
            if (container) {
                container.textContent = '';
                container.classList.remove('visible');
            }

            // Convert Title to filename format (Sentence case + .lrc)
            // "Doomed to Live" -> "Doomed to live.lrc"
            let filename = title.charAt(0).toUpperCase() + title.slice(1).toLowerCase() + '.lrc';

            try {
                const res = await fetch('lyrics/' + filename);
                if (!res.ok) throw new Error('No lyrics');
                const text = await res.text();
                parseLyrics(text);
            } catch (e) {
                console.log('Lyrics not found for:', title, e);
                // Fallback 1: Try exact title
                try {
                    const res2 = await fetch('lyrics/' + title + '.lrc');
                    if (res2.ok) {
                        const text2 = await res2.text();
                        parseLyrics(text2);
                        return; // Found it
                    }
                    throw new Error('Not found exact');
                } catch (e2) {
                    // Fallback 2: Try slugified (lowercase, no spaces)
                    // "Doomed to Live" -> "doomedtolive.lrc"
                    try {
                        const slug = title.replace(/\s+/g, '').toLowerCase() + '.lrc';
                        const res3 = await fetch('lyrics/' + slug);
                        if (res3.ok) {
                            const text3 = await res3.text();
                            parseLyrics(text3);
                        }
                    } catch (e3) { }
                }
            }
        }

        function parseLyrics(text) {
            const lines = text.split('\n');
            const regex = /^\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/;

            lyricsData = lines.map(line => {
                const match = line.match(regex);
                if (!match) return null;
                const min = parseInt(match[1]);
                const sec = parseInt(match[2]);
                const msPart = match[3];
                const content = match[4].trim();

                // Calculate time in seconds
                let ms = parseInt(msPart);
                if (msPart.length === 2) ms = ms / 100;
                else if (msPart.length === 3) ms = ms / 1000;

                return {
                    time: min * 60 + sec + ms,
                    text: content
                };
            }).filter(item => item !== null && item.text !== '');
        }

        function syncLyrics() {
            if (!lyricsData.length) return;

            const audio = document.getElementById('audioPlayer');
            const time = audio.currentTime;

            // Find current line (last line passed)
            let activeIndex = -1;
            for (let i = 0; i < lyricsData.length; i++) {
                if (time >= lyricsData[i].time) {
                    activeIndex = i;
                } else {
                    break;
                }
            }

            if (activeIndex !== currentLyricIndex) {
                currentLyricIndex = activeIndex;
                const line = lyricsData[activeIndex];
                const text = line ? line.text : ''; // Empty if before first timestamp
                updateLyricDisplay(text);
            }
        }

        function updateLyricDisplay(text) {
            const el = document.getElementById('currentLyricLine');
            if (!el) return;

            // Fade out
            el.classList.remove('visible');

            if (lyricTimeout) clearTimeout(lyricTimeout);

            // Wait for fade out, then swap text and fade in
            lyricTimeout = setTimeout(() => {
                el.textContent = text;
                if (text) el.classList.add('visible');
            }, 100); // Matches CSS transition duration
        }

        /* 
           NOTE: To make this work with REAL Stripe payments without a backend server:
           1. Go to Stripe Dashboard -> Products -> Add Product.
           2. Create a "Pay What You Want" pricing or fixed prices (£1, £3, £5).
           3. Get the "Payment Link" for each.
           4. Redirect the user to that link in the submitDonation function above.
        */

        async function captureEmail(email, name, track, amount) {
            // Placeholder if you want to log paid donations to DB
            console.log('Payment Success:', email, amount);
        }

        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            // Extract extension from URL
            const extension = url.split('.').pop();
            const cleanName = filename.replace(/\s+/g, '-').toLowerCase();
            a.download = `${cleanName}.${extension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        window.addEventListener('click', (e) => {
            const modal = document.getElementById('donationModal');
            if (e.target === modal) {
                // closeDonation(); // Legacy function, ignoring for now or should call closeModal?
                // The new modals have their own listeners usually or use the generic closeModal
            }
        });

        // Check for completed checkout session on page load
        window.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');

            if (sessionId) {
                // Check if payment was successful
                try {
                    const response = await fetch(`/api/session-status?session_id=${sessionId}`);
                    const { status, customer_email } = await response.json();

                    if (status === 'complete') {
                        // Clean up URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        alert(`Payment successful! Welcome to the club, ${customer_email || 'friend'}.`);
                    }
                } catch (error) {
                    console.error('Error checking session status:', error);
                }
            }
        });
    </script>
</body>

</html>