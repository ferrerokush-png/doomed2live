<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a0a0a">
    <title>ROCHE - DOOMED TO LIVE</title>
    <link href="https://fonts.googleapis.com/css2?family=Overpass+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="glitch.css">
    <style>
        .roche-glitch {
            font-size: clamp(2.5rem, 8vw, 6rem);
            font-family: 'Akira Expanded', sans-serif;
            font-weight: 700;
        }
    </style>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');
        
        @font-face {
            font-family: 'Akira Expanded';
            src: url('https://cdn.jsdelivr.net/gh/ferrerokush-png/doomed2live@main/AkiraExpanded-SuperBold.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --color-bg: #0a0a0a;
            --color-text: #f5f5f5;
            --color-text-secondary: #999;
            --color-accent: #b30000; /* Dark Red */
            --color-accent-hover: #ff0000; /* Brighter Red on hover */
            --color-highlight: #00d4ff; /* Blue for track highlights */
            --color-border: #222;
            --space-16: 16px;
            --space-24: 24px;
            --space-32: 32px;
            --radius-base: 4px;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-32) var(--space-32) 180px var(--space-32); /* Added bottom padding for fixed footer */
            width: 100%;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 50; /* Ensure container is above potential hidden views */
            pointer-events: auto; /* Ensure events work */
        }

        .logo {
            /* removed transition for top/left */
            position: fixed; /* Fixed position to stay in place */
            top: var(--space-24);
            left: var(--space-24);
            font-size: 14px;
            font-weight: 900; /* Maximum boldness */
            letter-spacing: 2px;
            color: #b30000;
            text-transform: uppercase;
            font-family: 'Space Mono', monospace;
            z-index: 1000; /* Ensure it stays on top */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-shadow: 0 0 0.5px #b30000; /* Slight shadow to enhance boldness */
        }

        /* Ensure message is clickable */
        .message {
            position: relative;
            z-index: 100; /* Bring above other elements */
            text-align: center;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .message:hover {
            opacity: 0.8;
        }
        
        .message h1 {
            font-size: clamp(2.5rem, 8vw, 6rem);
            font-weight: 700;
            margin: 0;
            letter-spacing: -1px;
            line-height: 1.2;
            font-family: 'Akira Expanded', sans-serif;
            pointer-events: auto; /* Ensure h1 specifically receives clicks */
        }

        

        .music-view {
            display: none;
            padding: 80px 24px 0 24px; /* No bottom padding, handled by content */
            padding-top: 120px; /* Push content lower visually */
            min-height: calc(100vh - 180px - 60px); /* Viewport minus footer (180px) and mini-player (60px) */
            align-items: flex-start; /* Start from top + padding */
            justify-content: flex-start; /* Allow manual spacing */
            flex-direction: column;
            padding-bottom: calc(180px + 60px + 20px); /* Footer + mini-player + extra spacing */
        }


        .back-button {
            position: fixed; /* Fixed position to stay relative to fixed logo */
            top: 60px; /* Positioned below the logo (approx 24px + height + gap) */
            left: var(--space-24);
            background: none;
            border: none;
            color: var(--color-text);
            font-size: 14px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: color 0.2s, opacity 1s ease; /* Added opacity transition */
            font-family: 'Space Mono', monospace;
            z-index: 999;
            opacity: 0; /* Start hidden */
        }

        .music-view.organized .back-button {
            opacity: 1; /* Fade in when organized */
        }

        .back-button:hover {
            color: var(--color-accent);
        }

        .release-header {
            margin-bottom: var(--space-32);
            text-align: center;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .ep-artwork {
            width: 100%;
            max-width: 300px;
            height: 300px;
            /* background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); Removed background color/gradient */
            /* border: 1px solid var(--color-border); Removed border if image covers it */
            border-radius: var(--radius-base);
            margin: 0 auto var(--space-32) auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            overflow: hidden; /* Ensure image stays within radius */
        }
        
        .ep-artwork img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .release-header h2 {
            font-size: 28px;
            margin: 0 0 var(--space-16) 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Akira Expanded', sans-serif;
        }

        .release-header p {
            color: var(--color-text-secondary);
            margin: 0;
            font-size: 12px;
            font-family: 'Space Mono', monospace;
        }

        .track-list {
            display: flex;
            flex-direction: column;
            gap: 0; /* Remove gap, use border/padding */
            max-width: 600px;
            margin: 0 auto;
            height: 100%; /* Fill the container */
        }

        .track-item {
            display: flex;
            flex-direction: column; 
            gap: 0; 
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); /* Smoother flex transition */
            padding: 0; 
            border: 1px solid transparent;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); /* Subtle divider */
            border-radius: 0; /* Square edges for stack look */
            overflow: hidden; 
            flex: 1; /* Distribute space evenly */
            min-height: 50px; /* Minimum height for collapsed state */
        }
        
        .track-item:hover {
            border-color: var(--color-highlight);
            border-width: 1px;
        }
        
        .track-item:last-child {
            border-bottom: none;
        }

        .track-item-content {
            display: flex;
            gap: var(--space-16);
            padding: var(--space-16);
            align-items: center; /* Center text vertically */
        }

        .track-item:hover:not(.active) {
            opacity: 1 !important; 
            border-color: var(--color-highlight);
            border-width: 2px;
            background: rgba(0, 212, 255, 0.03);
        }

        .track-item.active {
            border-color: var(--color-highlight);
            border-width: 2px;
            background: rgba(0, 212, 255, 0.05); 
            flex: 5; /* Grow MORE to ensure last item content fits */
            opacity: 1 !important;
        }

        /* Player Wrapper Animation */
        .track-player-wrapper {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.5s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .track-player-wrapper.expanded {
            grid-template-rows: 1fr;
            opacity: 1;
        }

        .track-player-inner {
            overflow: hidden;
            min-height: 0;
            opacity: 0;
            transition: opacity 0.3s ease 0.2s; /* Fade in content slightly after expansion starts */
        }

        .track-player-wrapper.expanded .track-player-inner {
            opacity: 1;
        }

        /* Modified Player Styles for inline display */
        .player {
            margin-top: 0;
            background: none;
            border: none;
            border-top: 1px solid var(--color-border);
            border-radius: 0;
            padding: var(--space-16);
            max-width: none;
            display: block; /* Always block, controlled by wrapper */
            opacity: 1; /* Remove fade in since wrapper animates height */
        }

        .download-full-ep-btn {
            display: inline-block;
            margin-top: var(--space-24);
            margin-left: auto;
            margin-right: auto;
            background: #b30000; /* Dark red matching theme */
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            border-radius: 6px;
            transition: all 0.2s ease;
            width: auto;
            max-width: 100%;
            box-shadow: 0 2px 4px rgba(179, 0, 0, 0.3);
        }

        .download-full-ep-btn:hover {
            background: #ff0000; /* Brighter red on hover */
            box-shadow: 0 4px 8px rgba(179, 0, 0, 0.4);
            transform: translateY(-1px);
        }
        
        .download-full-ep-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(179, 0, 0, 0.3);
        }

        .track-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .track-title {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
            color: var(--color-text);
            font-family: 'Akira Expanded', sans-serif;
        }

        .track-meta {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 4px;
            font-family: 'Space Mono', monospace;
        }

        .player {
            margin-top: var(--space-32);
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-24);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            display: none;
        }

        .player.active {
            display: block;
        }

        .player-title, .player-track {
            display: none;
        }

        .player-controls {
            display: flex;
            gap: var(--space-16);
            align-items: center;
            margin-bottom: var(--space-16);
        }

        button {
            background: none;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            border-radius: var(--radius-base);
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            font-family: 'Space Mono', monospace;
        }

        button:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }
        
        /* Specific class for download buttons - Dark red theme */
        .download-btn {
            background: #b30000 !important; /* Dark red matching theme */
            color: white !important;
            border: none !important;
            padding: 10px 20px !important;
            font-size: 12px !important;
            font-weight: 700 !important;
            text-transform: uppercase !important;
            letter-spacing: 1px !important;
            font-family: 'Space Mono', monospace !important;
            border-radius: 6px !important;
            box-shadow: 0 2px 4px rgba(179, 0, 0, 0.3) !important;
        }
        
        .download-btn:hover {
            background: #ff0000 !important; /* Brighter red on hover */
            box-shadow: 0 4px 8px rgba(179, 0, 0, 0.4) !important;
            transform: translateY(-1px);
            border-color: transparent !important;
            color: white !important;
        }
        
        .download-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(179, 0, 0, 0.3) !important;
        }

        .player-progress {
            width: 100%;
            height: 3px;
            background: var(--color-border);
            border-radius: 2px;
            margin-bottom: var(--space-16);
            cursor: pointer;
            position: relative;
        }

        .player-progress-fill {
            height: 100%;
            background: var(--color-accent);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .player-time {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-16);
            font-family: 'Space Mono', monospace;
        }

        /* Mini Player Styles - Fixed and attached to footer */
        .mini-player {
            position: fixed;
            bottom: 0; /* Attached to bottom */
            left: 0;
            right: 0;
            width: 100%;
            background: rgba(10, 10, 10, 0.98);
            border-top: 1px solid var(--color-border);
            padding: 16px 24px;
            z-index: 999; /* Above footer */
            transform: translateY(100%);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.4s ease;
            pointer-events: none;
        }

        .mini-player.visible {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .mini-player-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center; /* Center all content */
            gap: var(--space-24);
            flex-wrap: wrap;
        }

        .mini-player-info {
            flex: 0 1 auto; /* Don't grow, allow shrink */
            min-width: 0;
            text-align: center; /* Center the text */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .mini-player-track {
            font-size: 12px;
            font-weight: 700;
            color: var(--color-text);
            font-family: 'Akira Expanded', sans-serif;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px; /* Limit width for centering */
            text-align: center;
        }

        .mini-player-time {
            font-size: 10px;
            color: var(--color-text-secondary);
            font-family: 'Space Mono', monospace;
            margin-top: 4px;
            text-align: center;
        }

        .mini-player-controls {
            display: flex;
            align-items: center;
            justify-content: center; /* Center controls */
            gap: 16px;
            flex-shrink: 0;
        }

        .mini-player-btn {
            background: none;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            padding: 0;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .mini-player-btn:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .mini-player-progress {
            width: 180px;
            height: 3px;
            background: var(--color-border);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .mini-player-progress-fill {
            height: 100%;
            background: var(--color-accent);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 998; /* Below mini-player */
            border-top: 1px solid var(--color-border);
            padding: var(--space-32) var(--space-24);
            text-align: center;
            background: var(--color-bg); /* Ensure footer has background to cover content */
            pointer-events: auto; /* Ensure clickable */
        }

        /* Adjust footer position when mini-player is visible */
        body.has-mini-player footer {
            bottom: 64px; /* Push footer up when mini-player is visible (mini-player height ~64px with padding) */
        }

        .poem {
            font-size: 10px;
            color: var(--color-text); /* Made white for numbers */
            margin: 0 0 var(--space-16) 0;
            line-height: 1.4;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            font-family: 'Space Mono', monospace;
            font-weight: 700; /* Make everything bold like previous strong tags */
        }
        
        .poem a {
            color: var(--color-text); /* White by default */
            text-decoration: none;
            transition: color 0.2s;
            cursor: pointer;
        }

        .poem a:hover {
            color: #ff0000; /* Red on hover */
        }
        
        .poem br {
            content: " • ";
        }

        .socials {
            display: flex;
            gap: var(--space-24);
            justify-content: center;
            flex-wrap: wrap;
        }

        .social-link {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--color-text-secondary);
            text-decoration: none;
            transition: color 0.2s;
            font-family: 'Space Mono', monospace;
        }

        .social-link:hover {
            color: var(--color-accent);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            padding: var(--space-32);
            max-width: 500px;
            width: 90%;
            border-radius: var(--radius-base);
            position: relative;
        }

        #checkoutContent {
            max-width: 600px;
            padding: var(--space-24);
        }

        #checkout {
            margin-top: var(--space-16);
        }

        .modal-close {
            position: absolute;
            top: var(--space-16);
            right: var(--space-16);
            background: none;
            border: none;
            color: var(--color-text);
            font-size: 20px;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--color-accent);
        }

        .modal h3 {
            margin: 0 0 var(--space-24) 0;
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Akira Expanded', sans-serif;
        }

        .form-group {
            margin-bottom: var(--space-16);
        }

        .form-group label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            color: var(--color-text-secondary);
            font-family: 'Space Mono', monospace;
        }

        .form-group input {
            width: 100%;
            padding: 10px var(--space-16);
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            font-size: 14px;
            border-radius: var(--radius-base);
            transition: border-color 0.2s;
            font-family: 'Space Mono', monospace;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .amount-buttons {
            display: flex;
            gap: var(--space-16);
            margin-bottom: var(--space-16);
            flex-wrap: wrap;
        }

        .amount-btn {
            flex: 1;
            min-width: 70px;
            padding: 10px 8px;
            text-align: center;
            font-size: 12px;
        }

        .amount-btn.active {
            background: rgba(179, 0, 0, 0.1); /* Red tint */
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            background: var(--color-accent);
            color: var(--color-bg);
            font-weight: 700;
            margin-top: var(--space-16);
            border: none;
        }

        .submit-btn:hover {
            background: var(--color-accent-hover);
        }

        .modal p {
            margin: 0 0 var(--space-16) 0;
            color: var(--color-text-secondary);
            font-family: 'Space Mono', monospace;
        }
    
        /* Shift logo down when music view is active to avoid overlap with back button */
        /* REMOVED: Logo is now fixed at top left */
        /* body.music-active .logo { top: 64px; } */

        /* Responsive tweaks for small screens */
        @media (max-width: 768px) {
            .logo {
                top: 16px;
                left: 16px;
                font-size: 12px;
            }

            /* body.music-active .logo { top: 56px; } REMOVED */

            .back-button {
                top: 48px !important; /* Adjusted for smaller screens below logo */
                left: 16px !important;
                font-size: 12px;
                padding: 6px 10px;
                padding-left: 0; /* Align text with logo */
            }
        }

    </style>

<style>
/* CRT Effect & Header Transition */
.message h1 {
    transition: opacity 1.5s cubic-bezier(0.23, 1, 0.32, 1);
}

.message.clicked h1 {
    opacity: 0;
}
</style>

    <style>
        /* New Layout Styles */
        .music-content {
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center vertically on mobile */
            flex: 1; /* Take up available space */
            gap: var(--space-32);
            max-width: 1000px;
            width: 100%; 
            margin: 0 auto;
            opacity: 0; 
            transition: opacity 1s ease;
        }

        .music-view.visible .music-content {
            opacity: 1;
        }

        .release-info {
            width: 100%;
        }

        .tracks-area {
            width: 100%;
        }

        @media (min-width: 768px) {
            /* Apply layout to all music-content - archive view will override */
            .music-content {
                flex-direction: row;
                align-items: stretch; /* Stretch both columns to same height */
                justify-content: center;
                gap: 60px;
                height: 560px; /* Increased height for better fit */
                margin-top: 40px; /* Additional push down */
            }

            .release-info {
                flex: 0 0 320px;
                display: flex;
                flex-direction: column;
                justify-content: flex-start; /* Align to top */
                align-items: flex-start;
            }

            .tracks-area {
                flex: 1;
                max-width: 500px;
                height: 100%; /* Match parent height */
                overflow: hidden;
                display: flex;
                flex-direction: column;
                justify-content: flex-start; /* Align tracks to top */
            }
            
            .release-header {
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center; /* Center all children relative to cover art */
                width: 100%;
                margin-bottom: var(--space-24); /* Consistent spacing */
            }
            
            .release-header h2 {
                margin-top: 0;
                margin-bottom: var(--space-16);
            }
            
            .release-header p {
                margin-bottom: var(--space-24); /* Space before button */
            }
            
            .ep-artwork {
                margin-bottom: var(--space-24); /* Space before EP text */
            }
            
            .download-full-ep-btn {
                width: 100%;
                max-width: 300px; /* Match cover art width */
            }
            
            .track-list {
                height: 100%;
                display: flex;
                flex-direction: column;
                justify-content: flex-start; /* Align to top */
            }
            
            .ep-artwork {
                margin-left: 0;
                margin-right: 0; 
                width: 100%; /* Fill the 300px container */
                flex-shrink: 0; /* Prevent artwork shrinking */
            }

            .download-full-ep-btn {
                margin-left: 0;
                margin-right: 0;
                width: auto; /* Allow button to be smaller */
                margin-top: auto; /* Push to bottom */
            }
        }

        /* Disorganized to Organized Animation */
        .track-item {
            /* Initial disorganized state */
            opacity: 0;
            transform: translate(var(--tx), var(--ty)) rotate(var(--r));
            transition: 
                opacity 0.8s cubic-bezier(0.23, 1, 0.32, 1),
                transform 1.2s cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* Organized state */
        .music-view.organized .track-item {
            opacity: 1;
            transform: translate(0, 0) rotate(0);
        }
        
        .release-info {
            transition: opacity 1s ease, transform 1s ease;
            opacity: 0;
            transform: translateX(-20px);
        }
        
        .music-view.organized .release-info {
            opacity: 1;
            transform: none;
        }
        
        .player {
             transition: opacity 1s ease 0.5s; /* Delay player fade in */
             opacity: 0;
        }
        
        .music-view.organized .player {
             opacity: 1;
        }

        /* Older Music Section */
        .older-music-section {
            width: 100%;
            text-align: center;
            margin-top: auto;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
            transition: opacity 1s ease 0.5s, bottom 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            position: fixed;
            bottom: 140px; /* Default: attached to top of footer when no mini-player */
            left: 0;
            right: 0;
            z-index: 997; /* Above content, below footer/mini-player */
            flex-shrink: 0;
        }
        
        /* When mini-player is visible, attach Past Moods button to top of mini-player */
        body.has-mini-player .older-music-section {
            bottom: 204px; /* Attached to top of mini-player (64px mini-player + 140px footer = 204px) */
        }

        .music-view.organized .older-music-section {
            opacity: 1;
        }

        .older-music-btn {
            background: none;
            border: 1px solid var(--color-border);
            color: var(--color-text-secondary);
            padding: 16px 40px;
            font-size: 14px;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Akira Expanded', sans-serif;
        }

        /* Archive Grid Styles */
        #archiveList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 32px;
            padding: 0;
            height: auto;
            max-height: 100%;
            overflow-y: visible; /* Allow scrolling */
            border: none;
            justify-content: center; /* Center the grid items */
            max-width: 900px;
            margin: 0 auto; /* Center the grid container */
        }

        /* Archive View Specific Layout overrides */
        #archiveView .music-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: auto;
            min-height: 60vh;
            max-width: 1000px;
        }

        #archiveView .tracks-area {
            width: 100%;
            max-width: 1000px; /* Expand to full width */
            flex: unset;
            height: auto;
            overflow: visible;
        }
        
        /* Override archive view in media query to prevent layout conflicts */
        @media (min-width: 768px) {
            #archiveView .music-content {
                flex-direction: column;
                height: auto;
                margin-top: 0;
            }
            
            #archiveView .tracks-area {
                max-width: 1000px;
                height: auto;
            }
        }

        #archiveList::-webkit-scrollbar {
            width: 4px;
        }

        #archiveList::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        /* Override track-item for archive grid */
        #archiveList .track-item {
            flex: unset;
            width: 100%;
            height: auto;
            border: none;
            border-radius: var(--radius-base);
            background: transparent;
            margin: 0;
            min-height: 0;
            padding: 0;
            opacity: 0; /* Handled by JS animation */
        }

        #archiveList .track-item:hover {
            background: transparent;
            opacity: 1;
        }

        .archive-item {
            display: flex;
            flex-direction: column;
            gap: 12px;
            text-align: left;
            cursor: pointer;
        }

        .archive-thumb {
            width: 100%;
            aspect-ratio: 1; /* Square */
            overflow: hidden;
            border-radius: var(--radius-base);
            background: #222;
            position: relative;
        }

        .archive-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
            display: block;
        }

        .archive-item:hover .archive-thumb img {
            transform: scale(1.05);
        }

        .archive-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .archive-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--color-text);
            font-family: 'Akira Expanded', sans-serif;
            line-height: 1.2;
        }

        .archive-meta {
            font-size: 10px;
            color: var(--color-text-secondary);
            font-family: 'Space Mono', monospace;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="logo">ROCHÈ</div>

    <div class="container" id="homeView">
        <div class="message" onclick="goToMusic()">
            <h1 data-text="Welcome to the void">Welcome to the void</h1>
        </div>
    </div>

    <div class="music-view" id="musicView">
        <button class="back-button" onclick="goHome()">← Back</button>
        
        <div class="music-content">
            <div class="release-info">
                <div class="release-header">
                    <div class="ep-artwork">
                        <img src="doomedtolivecoverart.png" alt="Doomed To Live EP Cover">
                    </div>
                    <p id="releaseType">EP</p>
                    <button class="download-full-ep-btn" onclick="downloadFullEP()">Download Full EP</button>
                </div>
            </div>

            <div class="tracks-area">
                <div class="track-list" id="trackList"></div>
                <!-- Hidden Player Template that will be moved around -->
                <div id="playerTemplate" style="display: none;">
                    <div class="player" id="player">
                        <div class="player-title">Now Playing</div>
                        <div class="player-track" id="playerTrack">—</div>
                        <audio id="audioPlayer"></audio>
                        <div class="player-controls">
                            <button id="playBtn" onclick="togglePlay(event)">▶ Play</button>
                            <button class="download-btn" onclick="downloadTrack(event)">☕ Support & Download</button>
                        </div>
                        <div class="player-progress" onclick="seek(event)">
                            <div class="player-progress-fill" id="progressFill"></div>
                        </div>
                        <div class="player-time">
                            <span id="currentTime">0:00</span>
                            <span id="duration">3:00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Older Music Section (Outside the 2-column layout) -->
        <div class="older-music-section">
            <button class="older-music-btn" onclick="goToArchive()">PAST MOODS</button>
        </div>
    </div>

    <!-- Archive View (Reusing layout structure) -->
    <div class="music-view" id="archiveView">
        <button class="back-button" onclick="returnToLatest()">← Latest</button>
        
        <div class="music-content">
            <div class="tracks-area">
                <div class="track-list" id="archiveList">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Mini Player (appears above footer when playing) -->
    <div class="mini-player" id="miniPlayer">
        <div class="mini-player-content">
            <div class="mini-player-info">
                <div class="mini-player-track" id="miniPlayerTrack">—</div>
                <div class="mini-player-time" id="miniPlayerTime">0:00 / 0:00</div>
            </div>
            <div class="mini-player-controls">
                <button class="mini-player-btn" id="miniPlayBtn" onclick="togglePlayFromMini()">▶</button>
                <div class="mini-player-progress" onclick="seekMini(event)">
                    <div class="mini-player-progress-fill" id="miniProgressFill"></div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="poem">
            <a href="https://www.samaritans.org/" target="_blank" rel="noopener noreferrer">Samaritans</a> 116 123 • <a href="https://www.thecalmzone.net/" target="_blank" rel="noopener noreferrer">CALM</a> 0800 58 58 58 • <a href="https://www.papyrus-uk.org/" target="_blank" rel="noopener noreferrer">Papyrus</a> 0800 068 4141 • <a href="https://www.crisis.org.uk/get-help/" target="_blank" rel="noopener noreferrer">Crisis</a> 85258
        </div>
        <div class="socials">
            <a href="https://tiktok.com/@rocheofficiel" class="social-link">TikTok</a>
            <a href="https://instagram.com/rocheofficiel" class="social-link">Instagram</a>
            <a href="https://youtube.com/@rocheofficiel" class="social-link">YouTube</a>
            <a href="https://open.spotify.com/artist/2EJmFMBLaeIYrmKK15iQ3M" class="social-link">Spotify</a>
        </div>
    </footer>

    <div class="modal" id="donationModal">
        <div class="modal-content" id="donationFormContent">
            <button class="modal-close" onclick="closeDonation()">×</button>
            <h3>Support This Track</h3>
            <p>Choose your contribution. No amount is too small.</p>
            <div class="amount-buttons" id="amountButtons">
                <button class="amount-btn" onclick="setAmount(0, event)">Free</button>
                <button class="amount-btn" onclick="setAmount(1, event)">£1</button>
                <button class="amount-btn" onclick="setAmount(3, event)">£3</button>
                <button class="amount-btn" onclick="setAmount(5, event)">£5</button>
                <button class="amount-btn" onclick="setAmount(10, event)">£10</button>
            </div>
            <div class="form-group">
                <label>Custom Amount (£)</label>
                <input type="number" id="customAmount" placeholder="Enter amount (1-99)" min="1" max="99" step="0.01">
            </div>
            <div class="form-group">
                <label>Email *</label>
                <input type="email" id="donorEmail" placeholder="your@email.com" required>
            </div>
            <div class="form-group">
                <label>Name (Optional)</label>
                <input type="text" id="donorName" placeholder="Your name">
            </div>
            <button class="submit-btn" onclick="submitDonation()">Complete Support</button>
        </div>
        <!-- Embedded Checkout Container (hidden by default) -->
        <div class="modal-content" id="checkoutContent" style="display: none;">
            <button class="modal-close" onclick="closeCheckout()">×</button>
            <div id="checkout"></div>
        </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const musicData = {
            doomed: {
                title: 'Doomed to Live',
                type: 'EP',
                year: '2025',
                cover: 'doomedtolivecoverart.png',
                tracks: [
                    { title: 'Doomed to Live', duration: '3:45', downloadUrl: 'https://your-bunny-cdn.b-cdn.net/doomed-to-live.mp3' },
                    { title: 'If Only', duration: '4:12', downloadUrl: 'https://your-bunny-cdn.b-cdn.net/if-only.mp3' },
                    { title: 'Why Do Fools Fall In Love', duration: '3:58', downloadUrl: 'https://your-bunny-cdn.b-cdn.net/why-do-fools.mp3' },
                    { title: 'Mayday', duration: '3:32', downloadUrl: 'https://your-bunny-cdn.b-cdn.net/mayday.mp3' },
                    { title: 'End Like This', duration: '4:28', downloadUrl: 'https://your-bunny-cdn.b-cdn.net/end-like-this.mp3' }
                ]
            },
            armor: {
                title: 'Armor',
                type: 'Single',
                year: '2025',
                cover: 'old cover art/armor.jpg',
                tracks: [
                    { title: 'Armor', duration: '2:45', downloadUrl: '#' }
                ]
            },
            overu: {
                title: 'Over U',
                type: 'Single',
                year: '2025',
                cover: 'old cover art/over u.jpg',
                tracks: [
                    { title: 'Over U', duration: '2:50', downloadUrl: '#' }
                ]
            },
            rain: {
                title: 'Rain',
                type: 'Single',
                year: '2025',
                cover: 'old cover art/rain.jpg',
                tracks: [
                    { title: 'Rain', duration: '3:20', downloadUrl: '#' }
                ]
            },
            legaltender: {
                title: 'Legal Tender',
                type: 'Single',
                year: '2025',
                cover: 'old cover art/legal tender.jpg',
                tracks: [
                    { title: 'Legal Tender', duration: '2:55', downloadUrl: '#' }
                ]
            },
            americandream: {
                title: 'American Dream',
                type: 'Single',
                year: '2025',
                cover: 'old cover art/americandreams.jpg',
                tracks: [
                    { title: 'American Dream', duration: '3:15', downloadUrl: '#' }
                ]
            },
            interim: {
                title: 'Interim',
                type: 'Single',
                year: '2025',
                cover: 'old cover art/interim.jpg',
                tracks: [
                    { title: 'Interim', duration: '3:05', downloadUrl: '#' }
                ]
            },
            setmefree: {
                title: 'Set Me Free',
                type: 'Single',
                year: '2025',
                cover: 'old cover art/set me free.jpg',
                tracks: [
                    { title: 'Set Me Free', duration: '3:10', downloadUrl: '#' }
                ]
            },
            deepend: {
                title: 'Deep End',
                type: 'Single',
                year: '2024',
                cover: 'old cover art/Deep End.jpg',
                tracks: [
                    { title: 'Deep End', duration: '3:00', downloadUrl: '#' }
                ]
            },
            dejavu: {
                title: 'Deja Vu',
                type: 'Single',
                year: '2024',
                cover: 'old cover art/deja vu.jpg',
                tracks: [
                    { title: 'Deja Vu', duration: '3:00', downloadUrl: '#' }
                ]
            },
            mademan: {
                title: 'Made Man',
                type: 'Single',
                year: '2024',
                cover: 'old cover art/made man.jpg',
                tracks: [
                    { title: 'Made Man', duration: '3:00', downloadUrl: '#' }
                ]
            },
            playstation: {
                title: 'Playstation',
                type: 'Single',
                year: '2024',
                cover: 'old cover art/playstation.jpg',
                tracks: [
                    { title: 'Playstation', duration: '3:00', downloadUrl: '#' }
                ]
            },
            go: {
                title: 'GO',
                type: 'Single',
                year: '2023',
                cover: 'old cover art/go.jpg',
                tracks: [
                    { title: 'GO', duration: '2:30', downloadUrl: '#' }
                ]
            }
        };

        // Initialize Stripe
        const stripe = Stripe('pk_live_51SkeM0BlFcUia3s1u859vt0ycjJb4wU2oZJJt1yjx2VeeAOqSbjBnYZ5TV1ozmj1Qi3GRs1Um0eXwhRJCbzM2O0I00wzYDXNjj');
        let checkout = null;

        let currentTrack = null;
        let selectedAmount = 0;
        let isPlaying = false;
        let isFullEPDownload = false;
        let previousView = 'home'; // Track where we came from
        let placeholderAudio = null; // Cache for placeholder audio
        const trackPlaceholders = {}; // Cache placeholders per track

        function goToMusic() {
            const message = document.querySelector('.message');
            message.classList.add('clicked');
            
            previousView = 'home';

            setTimeout(() => {
                document.body.classList.add('music-active');
                document.getElementById('homeView').style.display = 'none';
                document.getElementById('archiveView').style.display = 'none'; // Ensure archive is hidden
                
                const musicView = document.getElementById('musicView');
                musicView.style.display = 'flex'; 
                
                // Trigger reflow
                void musicView.offsetWidth;
                
                musicView.classList.add('visible');
                loadEP('doomed'); // Default load
                
                setTimeout(() => {
                    musicView.classList.add('organized');
                }, 100);
            }, 1500); 
        }

        function goToArchive() {
            const musicView = document.getElementById('musicView');
            const archiveView = document.getElementById('archiveView');
            
            // Hide Music View
            musicView.classList.remove('visible', 'organized');
            
            setTimeout(() => {
                musicView.style.display = 'none';
                
                // Show Archive View
                archiveView.style.display = 'flex';
                void archiveView.offsetWidth;
                archiveView.classList.add('visible');
                
                loadArchive();
                
                setTimeout(() => {
                    archiveView.classList.add('organized');
                }, 100);
            }, 500);
        }

        function returnToLatest() {
            // Go back to the main Music View (Doomed to Live)
            const musicView = document.getElementById('musicView');
            const archiveView = document.getElementById('archiveView');
            
            archiveView.classList.remove('visible', 'organized');
            
            setTimeout(() => {
                archiveView.style.display = 'none';
                
                musicView.style.display = 'flex';
                void musicView.offsetWidth;
                musicView.classList.add('visible');
                loadEP('doomed'); // Reset to latest
                
                setTimeout(() => {
                    musicView.classList.add('organized');
                }, 100);
            }, 500);
        }

        function goHome() {
            document.body.classList.remove('music-active');
            const musicView = document.getElementById('musicView');
            const archiveView = document.getElementById('archiveView');
            
            // Stop audio and hide mini-player
            audioPlayer.pause();
            isPlaying = false;
            currentTrack = null;
            updateMiniPlayer();
            
            // Handle closing whichever view is open
            if(musicView.style.display !== 'none') {
                musicView.classList.remove('visible', 'organized');
                setTimeout(() => { musicView.style.display = 'none'; finishHomeTransition(); }, 500);
            } else {
                archiveView.classList.remove('visible', 'organized');
                setTimeout(() => { archiveView.style.display = 'none'; finishHomeTransition(); }, 500);
            }
        }
        
        function finishHomeTransition() {
            document.getElementById('homeView').style.display = 'flex';
            audioPlayer.pause();
            isPlaying = false;
            if(document.getElementById('playBtn')) document.getElementById('playBtn').textContent = '▶ Play';

            const message = document.querySelector('.message');
            message.classList.remove('clicked');
        }

        function loadEP(epKey) {
            const data = musicData[epKey];
            const musicView = document.getElementById('musicView');
            
            // Reset player state - move player back to template if it's in an old track
            const player = document.getElementById('player');
            const playerTemplate = document.getElementById('playerTemplate');
            
            // Remove active states from old tracks before clearing
            document.querySelectorAll('.track-item').forEach(item => {
                item.classList.remove('active');
                const wrapper = item.querySelector('.track-player-wrapper');
                if (wrapper) {
                    wrapper.classList.remove('expanded');
                }
            });
            
            // Ensure player is in template before clearing track list
            if (player && player.parentElement) {
                const currentParent = player.parentElement;
                // If player is not already in template, move it there
                if (currentParent.id !== 'playerTemplate') {
                    if (currentParent.removeChild) {
                        currentParent.removeChild(player);
                    }
                    if (playerTemplate) {
                        playerTemplate.appendChild(player);
                    }
                    player.style.display = 'none';
                }
            }
            
            // Reset current track state
            currentTrack = null;
            isPlaying = false;
            const audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.src = '';
                audioPlayer.load();
            }
            updateMiniPlayer();
            
            // Update Header Info
            // Title removed - only showing type now
            musicView.querySelector('#releaseType').textContent = data.type;
            
            // Update Cover Art
            const artworkImg = musicView.querySelector('.ep-artwork img');
            if(data.cover) {
                artworkImg.src = data.cover;
            } else {
                artworkImg.src = 'doomedtolivecoverart.png'; // Fallback
            }

            const trackList = document.getElementById('trackList');
            trackList.innerHTML = '';
            
            // Handle Download Button Visibility
            const downloadBtn = musicView.querySelector('.download-full-ep-btn');
            if (epKey === 'doomed') {
                downloadBtn.style.display = 'inline-block';
                // Also ensure Back button goes to Home
                musicView.querySelector('.back-button').onclick = goHome;
                musicView.querySelector('.back-button').textContent = "← Back";
                // Show Archive Button
                const olderMusicSection = musicView.querySelector('.older-music-section');
                if(olderMusicSection) olderMusicSection.style.display = 'block';
            } else {
                // If viewing an older release inside the main player view
                downloadBtn.style.display = 'none'; // Only Doomed has full EP download logic for now
                
                // Change Back button to return to Archive
                musicView.querySelector('.back-button').onclick = goToArchive;
                musicView.querySelector('.back-button').textContent = "← Archives";
                
                // Hide Archive Button (we are already in a sub-view)
                const olderMusicSection = musicView.querySelector('.older-music-section');
                if(olderMusicSection) olderMusicSection.style.display = 'none';
            }

            data.tracks.forEach((track, index) => {
                const trackEl = document.createElement('div');
                trackEl.className = 'track-item';
                
                // Random values for disorganization effect
                const tx = (Math.random() * 60 - 30) + 'px';
                const ty = (Math.random() * 60 + 20) + 'px';
                const r = (Math.random() * 10 - 5) + 'deg';
                
                trackEl.style.setProperty('--tx', tx);
                trackEl.style.setProperty('--ty', ty);
                trackEl.style.setProperty('--r', r);
                // Stagger transition delays
                trackEl.style.transitionDelay = (index * 0.05) + 's';

                // New HTML structure for inline player
                trackEl.innerHTML = `
                    <div class="track-item-content">
                        <div class="track-info">
                            <div class="track-title">${track.title}</div>
                            <div class="track-meta">${track.duration}</div>
                        </div>
                    </div>
                    <div class="track-player-wrapper">
                        <div class="track-player-inner"></div>
                    </div>
                `;
                
                // Pass event to prevent bubbling if clicking player controls
                trackEl.onclick = (e) => {
                    // Don't trigger if clicking inside the player controls
                    if (e.target.closest('.player') || e.target.closest('button')) return;
                    selectTrack(track, trackEl);
                };
                
                trackList.appendChild(trackEl);
            });
        }
        
        function loadArchive() {
            const list = document.getElementById('archiveList');
            list.innerHTML = '';
            
            // Filter keys (excluding 'doomed') and assume they are in chronological order (or user provided order)
            // If explicit sorting is needed based on year, we can do:
            // const keys = Object.keys(musicData)
            //    .filter(k => k !== 'doomed')
            //    .sort((a, b) => parseInt(musicData[b].year || 0) - parseInt(musicData[a].year || 0));
            // But preserving object definition order usually works if defined correctly.
            const keys = Object.keys(musicData).filter(k => k !== 'doomed'); 
            
            keys.forEach((key, index) => {
                const item = musicData[key];
                const el = document.createElement('div');
                el.className = 'track-item'; // Reuse animation class for fade in
                
                // Simplified animation for grid
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                el.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                el.style.transitionDelay = (index * 0.05) + 's';
                
                // Add organized class logic
                setTimeout(() => {
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                }, 50);
                
                el.innerHTML = `
                    <div class="archive-item" onclick="viewRelease('${key}')">
                        <div class="archive-thumb">
                            <img src="${item.cover || 'doomedtolivecoverart.png'}" 
                                 alt="${item.title}" 
                                 onerror="this.src='doomedtolivecoverart.png'">
                        </div>
                        <div class="archive-info">
                            <div class="archive-title">${item.title}</div>
                            <div class="archive-meta">${item.type} • ${item.year || '2025'}</div>
                        </div>
                    </div>
                `;
                list.appendChild(el);
            });
        }
        
        function viewRelease(key) {
            // Switch from Archive View to Music View (populated with release)
            const archiveView = document.getElementById('archiveView');
            const musicView = document.getElementById('musicView');
            
            archiveView.classList.remove('visible', 'organized');
            
            setTimeout(() => {
                archiveView.style.display = 'none';
                
                musicView.style.display = 'flex';
                void musicView.offsetWidth;
                musicView.classList.add('visible');
                
                loadEP(key);
                
                setTimeout(() => {
                    musicView.classList.add('organized');
                }, 100);
            }, 500);
        }

        function selectTrack(track, trackEl) {
            // Get the player element - ensure it exists
            const player = document.getElementById('player');
            const audioPlayer = document.getElementById('audioPlayer');
            
            if (!player) {
                console.error('Player element not found!');
                return;
            }
            
            if (!audioPlayer) {
                console.error('Audio player element not found!');
                return;
            }

            // Check if clicking the same track that's already expanded - if so, collapse it
            const currentParent = player.parentNode;
            const isSameTrack = currentTrack === track && currentParent && currentParent.closest('.track-item') === trackEl;
            const isCurrentlyExpanded = trackEl.classList.contains('active');
            
            if (isSameTrack && isCurrentlyExpanded) {
                // Toggle off - collapse the track
                trackEl.classList.remove('active');
                const wrapper = trackEl.querySelector('.track-player-wrapper');
                if (wrapper) {
                    wrapper.classList.remove('expanded');
                }
                
                // Reset audio
                audioPlayer.pause();
                isPlaying = false;
                document.getElementById('playBtn').textContent = '▶ Play';
                if (document.getElementById('miniPlayBtn')) {
                    document.getElementById('miniPlayBtn').textContent = '▶';
                }
                
                // Clear current track and hide mini-player
                currentTrack = null;
                updateMiniPlayer();
                
                return; // Exit early - track is now collapsed
            }

            // Remove active class from all items and collapse wrappers
            document.querySelectorAll('.track-item').forEach(item => {
                item.classList.remove('active');
                const wrapper = item.querySelector('.track-player-wrapper');
                if (wrapper) wrapper.classList.remove('expanded');
            });

            currentTrack = track;
            trackEl.classList.add('active');
            
            // Update Info
            const playerTrackEl = document.getElementById('playerTrack');
            if (playerTrackEl) {
                playerTrackEl.textContent = track.title;
            }
            
            // Move player to new location
            const newWrapper = trackEl.querySelector('.track-player-wrapper');
            const newInner = trackEl.querySelector('.track-player-inner');
            
            if (!newWrapper || !newInner) {
                console.error('Track player wrapper or inner not found!');
                return;
            }
            
            // If player is already in a different container, remove it first
            if (player.parentElement && player.parentElement !== newInner) {
                player.parentElement.removeChild(player);
            }
            
            // Ensure player is visible
            player.style.display = 'block';

            // Append player to the inner container of the clicked track
            newInner.appendChild(player);
            
            // Force a reflow to ensure the browser registers the move before animating
            void newWrapper.offsetWidth; 
            
            // Trigger animation
            requestAnimationFrame(() => {
                newWrapper.classList.add('expanded');
            });

            // Reset Audio logic
            audioPlayer.pause();
            isPlaying = false;
            document.getElementById('playBtn').textContent = '▶ Play';
            document.getElementById('currentTime').textContent = '0:00';
            document.getElementById('progressFill').style.width = '0%';
            
            // Generate placeholder audio for this specific track based on duration
            const durationParts = track.duration.split(':');
            const minutes = parseInt(durationParts[0]) || 0;
            const seconds = parseInt(durationParts[1]) || 0;
            const totalSeconds = minutes * 60 + seconds;
            const duration = totalSeconds || 180; // Default to 3 minutes if duration invalid
            
            if (!trackPlaceholders[track.title]) {
                trackPlaceholders[track.title] = generatePlaceholderAudio(duration);
            }
            audioPlayer.src = trackPlaceholders[track.title];
            audioPlayer.load();
            
            // Update duration display (will be updated when audio loads)
            
            // Update mini-player to show current track
            updateMiniPlayer();
            
            // Auto play on selection? User asked to "open the new one", implies showing it. 
            // We won't auto-play to avoid jarring noise, but we reset state.
        }

        function generatePlaceholderAudio(durationSeconds = 180) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const duration = durationSeconds || 180; // Default to 3 minutes
            const sampleRate = audioContext.sampleRate;
            const buffer = audioContext.createBuffer(1, duration * sampleRate, sampleRate);
            const data = buffer.getChannelData(0);

            // Create a more interesting tone with slight variation
            const baseFreq = 261.63; // C4
            for (let i = 0; i < buffer.length; i++) {
                const t = i / sampleRate;
                const freq = baseFreq + Math.sin(t * 0.5) * 10; // Slight vibrato
                data[i] = Math.sin(t * freq * 2 * Math.PI) * 0.2 * (1 - t / duration); // Fade out
            }

            const wav = audioBufferToWav(buffer);
            const blob = new Blob([wav], { type: 'audio/wav' });
            return URL.createObjectURL(blob);
        }

        function audioBufferToWav(audioBuffer) {
            const numberOfChannels = audioBuffer.numberOfChannels;
            const sampleRate = audioBuffer.sampleRate;
            const format = 1;
            const bitDepth = 16;
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numberOfChannels * bytesPerSample;
            const channels = [];
            for (let i = 0; i < numberOfChannels; i++) {
                channels.push(audioBuffer.getChannelData(i));
            }
            const length = audioBuffer.length * numberOfChannels * bytesPerSample;
            const arrayBuffer = new ArrayBuffer(44 + length);
            const view = new DataView(arrayBuffer);

            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            const floatTo16BitPCM = (output, offset, input) => {
                for (let i = 0; i < input.length; i++, offset += 2) {
                    const s = Math.max(-1, Math.min(1, input[i]));
                    output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
                }
            };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numberOfChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(36, 'data');
            view.setUint32(40, length, true);

            let offset = 44;
            for (let i = 0; i < numberOfChannels; i++) {
                floatTo16BitPCM(view, offset, channels[i]);
                offset += channels[i].length * bytesPerSample;
            }

            return arrayBuffer;
        }

        function togglePlay(event) {
            if (event) event.stopPropagation();
            if (!currentTrack) return;
            const audioPlayer = document.getElementById('audioPlayer');

            // Ensure we have placeholder audio for this track
            if (!audioPlayer.src || audioPlayer.src === '') {
                if (!trackPlaceholders[currentTrack.title]) {
                    const durationParts = currentTrack.duration.split(':');
                    const minutes = parseInt(durationParts[0]) || 0;
                    const seconds = parseInt(durationParts[1]) || 0;
                    const totalSeconds = minutes * 60 + seconds || 180;
                    trackPlaceholders[currentTrack.title] = generatePlaceholderAudio(totalSeconds);
                }
                audioPlayer.src = trackPlaceholders[currentTrack.title];
                audioPlayer.load();
            }

            if (isPlaying) {
                audioPlayer.pause();
                document.getElementById('playBtn').textContent = '▶ Play';
                if (document.getElementById('miniPlayBtn')) {
                    document.getElementById('miniPlayBtn').textContent = '▶';
                }
                isPlaying = false;
            } else {
                audioPlayer.play();
                document.getElementById('playBtn').textContent = '⏸ Pause';
                if (document.getElementById('miniPlayBtn')) {
                    document.getElementById('miniPlayBtn').textContent = '⏸';
                }
                isPlaying = true;
            }
            updateMiniPlayer();
        }

        function togglePlayFromMini() {
            togglePlay(null);
        }

        function seekMini(event) {
            seek(event);
        }

        function updateMiniPlayer() {
            const miniPlayer = document.getElementById('miniPlayer');
            // Only show mini-player when a song is actually playing
            if (currentTrack && isPlaying) {
                miniPlayer.classList.add('visible');
                document.body.classList.add('has-mini-player');
                document.getElementById('miniPlayerTrack').textContent = currentTrack.title;
                
                // Update time display
                const audioPlayer = document.getElementById('audioPlayer');
                if (audioPlayer && audioPlayer.duration) {
                    const current = Math.floor(audioPlayer.currentTime || 0);
                    const total = Math.floor(audioPlayer.duration);
                    const currentMinutes = Math.floor(current / 60);
                    const currentSeconds = current % 60;
                    const totalMinutes = Math.floor(total / 60);
                    const totalSeconds = total % 60;
                    document.getElementById('miniPlayerTime').textContent = 
                        `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')} / ${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
                } else {
                    document.getElementById('miniPlayerTime').textContent = '0:00 / 0:00';
                }
            } else {
                // Hide mini-player when not playing
                miniPlayer.classList.remove('visible');
                document.body.classList.remove('has-mini-player');
            }
        }

        function downloadTrack(event) {
            if (event) event.stopPropagation();
            if (!currentTrack) return;
            isFullEPDownload = false;
            document.getElementById('donationModal').classList.add('active');
        }

        function downloadFullEP() {
            isFullEPDownload = true;
            // Set a dummy "current track" for the modal title or logic if needed, 
            // or modify modal logic to handle full EP text
            document.querySelector('#donationModal h3').textContent = "Support Full EP";
            document.getElementById('donationModal').classList.add('active');
        }

        function seek(event) {
            if (!audioPlayer.src || !audioPlayer.duration) return;
            const rect = event.currentTarget.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = percent * audioPlayer.duration;
        }

        audioPlayer.addEventListener('timeupdate', () => {
            const current = Math.floor(audioPlayer.currentTime);
            const minutes = Math.floor(current / 60);
            const seconds = current % 60;
            const currentTimeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('currentTime').textContent = currentTimeStr;
            
            // Update mini-player time
            if (document.getElementById('miniPlayerTime')) {
                const totalMinutes = Math.floor(audioPlayer.duration / 60) || 0;
                const totalSeconds = Math.floor(audioPlayer.duration % 60) || 0;
                const durationStr = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
                document.getElementById('miniPlayerTime').textContent = `${currentTimeStr} / ${durationStr}`;
            }
            
            const percent = audioPlayer.duration ? (audioPlayer.currentTime / audioPlayer.duration) * 100 : 0;
            document.getElementById('progressFill').style.width = percent + '%';
            if (document.getElementById('miniProgressFill')) {
                document.getElementById('miniProgressFill').style.width = percent + '%';
            }
        });

        audioPlayer.addEventListener('loadedmetadata', () => {
            // Update duration when audio loads
            const totalMinutes = Math.floor(audioPlayer.duration / 60) || 0;
            const totalSeconds = Math.floor(audioPlayer.duration % 60) || 0;
            document.getElementById('duration').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            updateMiniPlayer();
        });

        audioPlayer.addEventListener('ended', () => {
            document.getElementById('playBtn').textContent = '▶ Play';
            if (document.getElementById('miniPlayBtn')) {
                document.getElementById('miniPlayBtn').textContent = '▶';
            }
            isPlaying = false;
            updateMiniPlayer();
        });

        audioPlayer.addEventListener('play', () => {
            updateMiniPlayer();
        });

        audioPlayer.addEventListener('pause', () => {
            updateMiniPlayer();
        });

        function setAmount(amount, event) {
            selectedAmount = amount;
            const customInput = document.getElementById('customAmount');
            
            if (amount === 0) {
                // Hide custom amount input for Free option
                customInput.value = '';
                customInput.parentElement.style.display = 'none';
            } else {
                // Show custom amount input for paid options (or clear it if specific amount selected)
                customInput.parentElement.style.display = 'block';
                customInput.value = '';
            }

            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function closeDonation() {
            document.getElementById('donationModal').classList.remove('active');
            // Reset state
            setTimeout(() => {
                document.querySelector('#donationModal h3').textContent = "Support This Track";
                document.getElementById('customAmount').parentElement.style.display = 'block'; // Reset visibility
                document.getElementById('customAmount').value = '';
                document.getElementById('donorEmail').value = '';
                document.getElementById('donorName').value = '';
                document.querySelectorAll('.amount-btn').forEach(btn => btn.classList.remove('active'));
                selectedAmount = 0;
            }, 300);
        }

        async function submitDonation() {
            const email = document.getElementById('donorEmail').value;
            const name = document.getElementById('donorName').value;
            const customAmount = document.getElementById('customAmount').value;
            const amount = customAmount ? parseFloat(customAmount) : selectedAmount;
            
            const itemTitle = isFullEPDownload ? "Doomed to Live (Full EP)" : currentTrack.title;
            const downloadUrl = isFullEPDownload ? "https://your-bunny-cdn.b-cdn.net/doomed-to-live-full-ep.zip" : currentTrack.downloadUrl; // Example URL

            if (!email) {
                alert('Please enter your email');
                return;
            }

            if (amount === '' || amount === 0 || amount === '0') {
                // Free download - just capture email
                await captureEmail(email, name, itemTitle, 'Free');
                downloadFile(downloadUrl, itemTitle);
                alert(`Thank you for supporting ROCHE!\n\nItem: ${itemTitle}\nEmail: ${email}`);
                document.getElementById('donorEmail').value = '';
                document.getElementById('donorName').value = '';
                closeDonation();
            } else if (amount < 1) {
                alert('Minimum donation is £1');
                return;
            } else {
                // Paid Option - Use Stripe Embedded Checkout
                await initializeEmbeddedCheckout(email, name, amount, itemTitle, downloadUrl);
            }
        }

        async function initializeEmbeddedCheckout(email, name, amount, itemTitle, downloadUrl) {
            try {
                // Hide donation form, show checkout container
                document.getElementById('donationFormContent').style.display = 'none';
                document.getElementById('checkoutContent').style.display = 'block';

                // Call your backend to create a Checkout Session
                // Replace 'YOUR_BACKEND_URL' with your actual server URL (e.g., 'http://localhost:4242' for local testing)
                const response = await fetch('YOUR_BACKEND_URL/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: amount,
                        email: email,
                        name: name,
                        itemTitle: itemTitle
                    })
                });

                const { clientSecret, error } = await response.json();

                if (error) {
                    alert('Error: ' + error.message);
                    closeCheckout();
                    return;
                }

                // Initialize embedded checkout
                checkout = await stripe.initEmbeddedCheckout({
                    clientSecret: clientSecret
                });

                // Mount the checkout form
                checkout.mount(document.getElementById('checkout'));

                // Listen for checkout completion
                checkout.on('complete', async () => {
                    // Get session ID from URL or from checkout session
                    const urlParams = new URLSearchParams(window.location.search);
                    const sessionId = urlParams.get('session_id');

                    if (sessionId) {
                        // Verify payment succeeded
                        const statusResponse = await fetch(`YOUR_BACKEND_URL/session-status?session_id=${sessionId}`);
                        const { status, customer_email } = await statusResponse.json();

                        if (status === 'complete') {
                            // Success! Unlock the download
                            await captureEmail(customer_email || email, name, itemTitle, `£${amount}`);
                            downloadFile(downloadUrl, itemTitle);
                            alert('Thank you for joining the club.');
                            closeCheckout();
                        }
                    }
                });

            } catch (error) {
                console.error('Checkout error:', error);
                alert('Failed to initialize checkout. Please try again.');
                closeCheckout();
            }
        }

        function closeCheckout() {
            // Clean up embedded checkout
            if (checkout) {
                checkout.unmount();
                checkout = null;
            }
            // Hide checkout, show form
            document.getElementById('checkoutContent').style.display = 'none';
            document.getElementById('donationFormContent').style.display = 'block';
            // Reset form
            closeDonation();
        }

        /* 
           NOTE: To make this work with REAL Stripe payments without a backend server:
           1. Go to Stripe Dashboard -> Products -> Add Product.
           2. Create a "Pay What You Want" pricing or fixed prices (£1, £3, £5).
           3. Get the "Payment Link" for each.
           4. Redirect the user to that link in the submitDonation function above.
        */

        async function processStripePayment(email, name, amount, trackTitle) {
             // Deprecated in favor of the simpler redirection logic above for static sites
             // unless you deploy a backend server.
        }

        async function captureEmail(email, name, track, amount) {
            // Send to your backend to store in database/email service
            try {
                await fetch('YOUR_BACKEND_URL/capture-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        name: name,
                        track: track,
                        amount: amount,
                        timestamp: new Date().toISOString()
                    })
                });
                console.log('✓ Email captured:', email);
            } catch (error) {
                console.error('Email capture error:', error);
            }
        }

        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename.replace(/\s+/g, '-').toLowerCase() + '.mp3';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        window.addEventListener('click', (e) => {
            const modal = document.getElementById('donationModal');
            if (e.target === modal) {
                closeDonation();
            }
        });

        // Check for completed checkout session on page load
        window.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');

            if (sessionId) {
                // Check if payment was successful
                try {
                    const response = await fetch(`YOUR_BACKEND_URL/session-status?session_id=${sessionId}`);
                    const { status } = await response.json();

                    if (status === 'complete') {
                        // Clean up URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        alert('Payment successful! Thank you for joining the club.');
                    }
                } catch (error) {
                    console.error('Error checking session status:', error);
                }
            }
        });
    </script>
</body>
</html>